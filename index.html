<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Fretboard Trainer</title>
    <meta name="description" content="Master the guitar fretboard with an interactive trainer. Test your note knowledge with quizzes, practice with a metronome, and track your progress. Perfect for all guitar players.">
    <link rel="canonical" href="https://fretmemo.net/" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://fretmemo.net/">
    <meta property="og:title" content="Guitar Fretboard Trainer">
    <meta property="og:description" content="Master the guitar fretboard with an interactive trainer. Test your note knowledge with quizzes, practice with a metronome, and track your progress. Perfect for all guitar players.">
    <meta property="og:image" content="https://fretmemo.net/fretmemo-preview.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://fretmemo.net/">
    <meta property="twitter:title" content="Guitar Fretboard Trainer">
    <meta property="twitter:description" content="Master the guitar fretboard with an interactive trainer. Test your note knowledge with quizzes, practice with a metronome, and track your progress. Perfect for all guitar players.">
    <meta property="twitter:image" content="https://fretmemo.net/fretmemo-preview.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #ffffff;
            --bg-panel: #f7f7f7;
            --text-dark: #1f1f1f;
            --text-light: #6b7280;
            --accent-color: #3b82f6;
            --accent-color-translucent: rgba(59, 130, 246, 0.3);
            --border-color: #e5e7eb;
        }

        body.dark {
            --bg-light: #111827;
            --bg-panel: #1f2937;
            --text-dark: #f9fafb;
            --text-light: #9ca3af;
            --accent-color: #60a5fa;
            --accent-color-translucent: rgba(96, 165, 250, 0.3);
            --border-color: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow-x: hidden;
            position: relative;
        }
        
        *:focus-visible {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
            border-radius: 0.25rem;
        }

        /* --- Side Panel --- */
        #side-panel {
            flex-shrink: 0;
            width: 320px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }
        
        #side-panel h2 {
            font-size: 1.25rem;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
        }

        #side-panel h3 {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            color: var(--text-light);
        }
        
        #side-panel label, #side-panel .label-text {
             font-size: 0.875rem; /* 14px */
             color: var(--text-dark);
        }
        
        .setting-group {
            padding-bottom: 1.25rem;
            margin-bottom: 1.25rem;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-group:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        #main-content {
            width: 100%;
            transition: margin-left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        body.panel-visible #side-panel {
            transform: translateX(0);
        }

        body.panel-visible #main-content {
            margin-left: 320px;
            width: calc(100% - 320px);
        }
        
        #settings-toggle-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 101;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        body.dark #settings-toggle-btn {
            background-color: rgba(31, 41, 55, 0.8);
        }

        body.panel-visible #settings-toggle-btn {
             transform: translateX(320px);
        }

        /* --- Fretboard --- */
        #fretboard {
            background: var(--bg-light);
            border: 2px solid var(--text-dark);
            display: grid;
        }

        /* Lefty Mode */
        body.lefty #fretboard-container {
            transform: scaleX(-1);
        }
        body.lefty .fret, body.lefty #fret-numbers > div > div {
             transform: scaleX(-1);
        }

        .fret { 
            border-right: 2px solid #a0a0a0; 
        }
        .fret[data-fret='0'] {
            border-right-width: 6px;
            border-right-color: var(--text-dark);
        }
        .fret[data-fret='12'] {
            border-right: none;
        }
        .string-line { background-color: #525252; }
        .marker-dot {
            background-color: #d4d4d4;
            body.dark & { background-color: #4b5563; }
        }

        /* --- Note Highlight --- */
        #highlight-dot {
            background-color: transparent;
            border: 4px solid var(--accent-color);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            z-index: 10;
            position: absolute; /* Changed for performance */
            pointer-events: none; /* Changed for performance */
        }
        
        /* --- Modern UI Elements in Panel --- */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 9999px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid var(--bg-panel);
            margin-top: -7px;
            transition: transform 0.1s ease-in-out;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        input[type=number], select {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-dark);
            font-size: 0.875rem;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            padding: 0.5rem 0.75rem;
        }
        input[type=number]:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-color-translucent);
        }
        
        input[type=checkbox] {
            -webkit-appearance: none;
            appearance: none;
            background-color: var(--bg-light);
            margin: 0;
            font: inherit;
            color: var(--text-dark);
            width: 1.25em;
            height: 1.25em;
            border: 1px solid var(--border-color);
            border-radius: 0.25em;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            cursor: pointer;
        }
        input[type=checkbox]::before {
            content: "";
            width: 0.75em;
            height: 0.75em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em var(--accent-color);
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        input[type=checkbox]:checked::before {
            transform: scale(1);
        }
        input[type=checkbox]:focus {
             outline: none;
        }
         input[type=checkbox]:focus-visible {
            box-shadow: 0 0 0 3px var(--accent-color-translucent);
        }
        
        /* --- Switcher Buttons --- */
        .switcher-btn {
            color: var(--text-light);
        }
        .switcher-btn.active {
            background-color: var(--accent-color);
            color: var(--bg-light);
            font-weight: bold;
        }
        .switcher-btn:focus {
            outline: none;
        }
        .switcher-btn:focus-visible {
            box-shadow: 0 0 0 3px var(--accent-color-translucent);
            z-index: 1;
        }
        
        /* --- Practice Note Display --- */
        .practice-note-container {
            min-height: 288px;
        }
        .current-practice-note {
            font-size: 10rem;
            line-height: 1;
            color: var(--text-dark);
        }
        .beat-dot {
            transition: all 0.2s ease-in-out;
        }
        .beat-dot.active {
            background-color: var(--accent-color);
            transform: scale(1.25);
        }

        /* --- Tablature View --- */
        .tab-string {
            height: 2.5rem;
            border-bottom: 2px solid #a0a0a0;
            display: flex;
            align-items: center;
        }
        .tab-fret-number {
            color: var(--accent-color);
            font-weight: bold;
        }

        /* --- Tuner Display --- */
        #tuner-display.correct {
            background-color: #dcfce7;
            border-color: #4ade80;
            color: #166534;
        }
        body.dark #tuner-display.correct {
             background-color: #166534;
             border-color: #4ade80;
             color: #dcfce7;
        }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QVM7JS1NZW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QVM7JS1NZW');
    </script>
    
    <!-- Schema.org for WebApplication -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Guitar Fretboard Trainer",
      "description": "Master the guitar fretboard with an interactive trainer. Test your note knowledge with quizzes, practice with a metronome, and track your progress. Perfect for all guitar players.",
      "url": "https://fretmemo.net/",
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Any",
      "browserRequirements": "Requires HTML5 support",
      "offers": {
        "@type": "Offer",
        "price": "0"
      }
    }
    </script>
</head>
<body class="panel-hidden">

    <!-- Settings Toggle Button -->
    <button id="settings-toggle-btn" class="px-3 py-2 text-gray-600 hover:text-black rounded-md font-semibold text-sm">
        Settings
    </button>
    
    <!-- Side Panel with Settings -->
    <div id="side-panel">
        <div class="flex-grow overflow-y-auto pr-2">
            <h2 style="color: var(--text-dark);">Settings</h2>
            
            <div class="setting-group">
                <h3>Metronome</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label for="bpm-slider" class="font-medium">Tempo</label>
                            <span id="bpm-display" class="text-sm font-bold px-2 py-1 rounded-md" style="background-color: var(--bg-light); color: var(--text-dark);">60 BPM</span>
                        </div>
                        <input type="range" id="bpm-slider" min="30" max="280" value="60" class="w-full">
                    </div>
                    <div>
                        <label for="note-duration" class="block text-left font-medium mb-2">Note Duration (beats)</label>
                        <input type="number" id="note-duration" value="1" min="1" class="w-full text-center">
                    </div>
                    <div>
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="speed-up-toggle">
                            <label for="speed-up-toggle" class="font-medium">Accelerate Automatically</label>
                        </div>
                        <div id="speed-up-controls" class="grid grid-cols-2 gap-3 mt-3 max-h-0 overflow-hidden opacity-0 transition-all duration-300">
                            <div>
                                <label for="speed-up-amount" class="text-xs" style="color: var(--text-light);">By BPM</label>
                                <input type="number" id="speed-up-amount" value="5" min="1" class="w-full rounded-md text-center mt-1">
                            </div>
                            <div>
                                <label for="speed-up-interval" class="text-xs" style="color: var(--text-light);">Every X beats</label>
                                <input type="number" id="speed-up-interval" value="8" min="1" class="w-full rounded-md text-center mt-1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="practice-settings-container" class="setting-group hidden">
                 <h3>Practice Settings</h3>
                 <div class="space-y-4">
                    <div>
                        <label for="interval-select" class="block text-left font-medium mb-2">Note Sequence</label>
                        <select id="interval-select" class="w-full rounded-md">
                            <option value="random">Random</option>
                            <option value="minorThirds">Minor Thirds</option>
                            <option value="majorThirds">Major Thirds</option>
                            <option value="fourths">Fourths</option>
                            <option value="fifths">Fifths</option>
                            <option value="sevenths">Sevenths</option>
                        </select>
                    </div>
                     <div class="flex items-center gap-3">
                        <input type="checkbox" id="mic-enable-toggle">
                        <label for="mic-enable-toggle" class="font-medium">Enable Microphone Input</label>
                    </div>
                </div>
            </div>

            <div class="setting-group">
                <h3>Note Settings</h3>
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="naturals-only-toggle">
                        <label for="naturals-only-toggle" class="font-medium">Naturals Only</label>
                    </div>
                    <div>
                        <span class="block text-left font-medium mb-2 label-text">Choose notes to practice:</span>
                        <div id="note-selection-grid" class="grid grid-cols-4 gap-2">
                            <!-- Checkboxes will be generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="setting-group">
                <h3>Appearance</h3>
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="dark-mode-toggle">
                        <label for="dark-mode-toggle" class="font-medium">Dark Mode</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="lefty-toggle">
                        <label for="lefty-toggle" class="font-medium">Left-Handed Mode</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-shrink-0 border-t pt-4 mt-4" style="border-color: var(--border-color);">
            <p class="text-sm" style="color: var(--text-light);">
                Feedback: 
                <a href="mailto:raf.janicki@gmail.com" class="underline hover:text-accent-color">raf.janicki@gmail.com</a>
            </p>
            <a href='https://ko-fi.com/ianix' target='_blank' class="mt-4 inline-block">
                <img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi2.png?v=3' border='0' alt='Buy Me a Coffee at ko-fi.com' />
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-6xl mx-auto text-center p-4">
            <header class="mb-4">
                <h1 class="text-4xl font-bold" style="color: var(--text-dark);">Guitar Fretboard Trainer</h1>
                <p class="mt-2" style="color: var(--text-light);">Choose your training mode</p>
                <!-- Module Switcher -->
                <div role="tablist" aria-label="Training Mode" class="mt-4 flex justify-center bg-gray-100 p-1 rounded-lg max-w-sm mx-auto" style="background-color: var(--bg-panel);">
                    <button role="tab" aria-selected="true" data-module="guessNote" class="switcher-btn module-switch-btn active w-1/2 p-2 rounded-md transition-colors">Guess the Note</button>
                    <button role="tab" aria-selected="false" data-module="playPractice" class="switcher-btn module-switch-btn w-1/2 p-2 rounded-md transition-colors">Playing Practice</button>
                </div>
                <div id="stats-display" class="mt-4 text-lg flex justify-center items-center space-x-6 bg-gray-100 p-2 rounded-lg max-w-xs mx-auto" style="background-color: var(--bg-panel);">
                    <div>
                        <span class="text-green-600 font-bold">Correct: </span>
                        <span id="correct-count">0</span>
                    </div>
                    <div class="border-l h-6" style="border-color: var(--border-color);"></div>
                    <div>
                        <span class="text-red-600 font-bold">Incorrect: </span>
                        <span id="incorrect-count">0</span>
                    </div>
                </div>
            </header>

            <div id="view-switcher-container">
                <div role="tablist" aria-label="View Mode" class="mt-4 flex justify-center bg-gray-100 p-1 rounded-lg max-w-md mx-auto" style="background-color: var(--bg-panel);">
                    <button role="tab" aria-selected="true" data-view="fretboard" class="switcher-btn view-switch-btn active w-1/3 p-2 rounded-md transition-colors text-sm">Fretboard → Note</button>
                    <button role="tab" aria-selected="false" data-view="tab" class="switcher-btn view-switch-btn w-1/3 p-2 rounded-md transition-colors text-sm">Tab → Note</button>
                    <button role="tab" aria-selected="false" data-view="noteToTab" class="switcher-btn view-switch-btn w-1/3 p-2 rounded-md transition-colors text-sm">Note → Tab</button>
                </div>
            </div>
            
            <div id="fretboard-container" class="relative w-full overflow-x-auto pb-8 mt-4">
                <div id="fretboard" class="rounded-lg shadow-lg py-2" style="grid-template-rows: repeat(6, 1fr);"></div>
                <div id="fret-numbers" class="relative mt-1"><div class="grid"></div></div>
            </div>

            <div id="tab-container" class="hidden relative w-full max-w-xl mx-auto pb-8 mt-4 font-mono text-xl p-4">
                 <!-- Tablature view will be generated here -->
            </div>

            <div id="note-to-tab-question-container" class="hidden practice-note-container flex flex-col items-center justify-center">
                 <span class="current-practice-note font-bold"></span>
            </div>
            
            <div id="practice-note-container" class="hidden practice-note-container flex flex-col items-center justify-center">
                <span class="current-practice-note font-bold"></span>
                <div id="tuner-container" class="mt-4 h-16">
                    <div id="tuner-display" class="hidden items-center justify-center p-3 rounded-lg border-2 bg-gray-100 transition-colors" style="border-color: var(--border-color); background-color: var(--bg-panel);">
                        <span class="text-xs uppercase tracking-widest mr-3" style="color: var(--text-light);">Detected:</span>
                        <span id="detected-note" class="text-2xl font-bold w-16" style="color: var(--text-dark);">-</span>
                    </div>
                </div>
                <div class="mt-4 text-center h-16">
                     <span class="text-xs uppercase tracking-widest" style="color: var(--text-light);">Next</span>
                     <span id="next-practice-note" class="block text-4xl font-semibold" style="color: var(--text-light);"></span>
                </div>
                <div id="beat-dots-container" class="flex justify-center items-center gap-3 mt-2 h-6"></div>
            </div>

            <div id="answer-options" class="mt-8 grid grid-cols-2 sm:grid-cols-4 gap-4 max-w-2xl mx-auto"></div>
            <div id="feedback" class="mt-6 h-10 text-2xl font-semibold transition-opacity duration-300"></div>
            
            <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-4">
                <button id="metronome-btn" class="w-full sm:w-auto px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Start Metronome
                </button>
                <button id="next-btn" class="w-full sm:w-auto px-8 py-3 bg-gray-700 hover:bg-gray-800 text-white font-bold rounded-lg shadow-md transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-gray-300">
                    Next Note
                </button>
                <button id="stats-btn" class="w-full sm:w-auto px-6 py-3 bg-gray-700 hover:bg-gray-800 text-white font-bold rounded-lg shadow-md transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-gray-300">
                    Show Stats
                </button>
            </div>
        </div>
    </div>

    <div id="stats-modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="stats-modal" role="dialog" aria-modal="true" aria-labelledby="stats-modal-title" class="rounded-lg shadow-2xl w-full max-w-md border" style="background-color: var(--bg-light); border-color: var(--border-color);">
            <div class="flex justify-between items-center p-4 border-b" style="border-color: var(--border-color);">
                <h2 id="stats-modal-title" class="text-2xl font-bold" style="color: var(--text-dark);">Mistake Statistics</h2>
                <button id="close-stats-btn" aria-label="Close statistics" class="hover:text-black text-2xl font-bold" style="color: var(--text-light);">&times;</button>
            </div>
            <div id="stats-content" class="p-6 max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Data Model ---
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const tuning = ['E', 'B', 'G', 'D', 'A', 'E'];
            const FRET_COUNT = 12;

            // --- DOM Elements ---
            const bodyEl = document.body;
            const fretboardEl = document.getElementById('fretboard');
            const fretboardContainer = document.getElementById('fretboard-container');
            const fretNumbersEl = document.querySelector('#fret-numbers div');
            const answerOptionsEl = document.getElementById('answer-options');
            const feedbackEl = document.getElementById('feedback');
            const nextBtn = document.getElementById('next-btn');
            const sidePanel = document.getElementById('side-panel');
            const settingsToggleBtn = document.getElementById('settings-toggle-btn');
            const bpmSlider = document.getElementById('bpm-slider');
            const bpmDisplay = document.getElementById('bpm-display');
            const metronomeBtn = document.getElementById('metronome-btn');
            const noteDurationInput = document.getElementById('note-duration');
            const speedUpToggle = document.getElementById('speed-up-toggle');
            const speedUpControls = document.getElementById('speed-up-controls');
            const speedUpAmount = document.getElementById('speed-up-amount');
            const speedUpInterval = document.getElementById('speed-up-interval');
            const correctCountEl = document.getElementById('correct-count');
            const incorrectCountEl = document.getElementById('incorrect-count');
            const statsDisplay = document.getElementById('stats-display');
            const statsBtn = document.getElementById('stats-btn');
            const statsModalOverlay = document.getElementById('stats-modal-overlay');
            const statsModal = document.getElementById('stats-modal');
            const statsContentEl = document.getElementById('stats-content');
            const closeStatsBtn = document.getElementById('close-stats-btn');
            const moduleSwitchBtns = document.querySelectorAll('.module-switch-btn');
            const practiceNoteContainer = document.getElementById('practice-note-container');
            const nextPracticeNoteEl = document.getElementById('next-practice-note');
            const beatDotsContainer = document.getElementById('beat-dots-container');
            const naturalsOnlyToggle = document.getElementById('naturals-only-toggle');
            const noteSelectionGrid = document.getElementById('note-selection-grid');
            const viewSwitcherContainer = document.getElementById('view-switcher-container');
            const viewSwitchBtns = document.querySelectorAll('.view-switch-btn');
            const tabContainer = document.getElementById('tab-container');
            const noteToTabQuestionContainer = document.getElementById('note-to-tab-question-container');
            const practiceSettingsContainer = document.getElementById('practice-settings-container');
            const intervalSelect = document.getElementById('interval-select');
            const micEnableToggle = document.getElementById('mic-enable-toggle');
            const tunerDisplay = document.getElementById('tuner-display');
            const detectedNoteEl = document.getElementById('detected-note');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const leftyToggle = document.getElementById('lefty-toggle');
            
            // --- Application State ---
            let currentModule = 'guessNote';
            let currentView = 'fretboard';
            let correctAnswer = '';
            let isAnswered = false;
            let metronomeIntervalId = null;
            let isMetronomeOn = false;
            let isCountingIn = false;
            let countInCounter = 0;
            const COUNT_IN_BEATS = 4;
            let speedUpTickCounter = 0;
            let noteTickCounter = 0;
            let audioCtx;
            let analyser;
            let micStream;
            let pitchDetectionFrameId;
            let isPitchDetectionRunning = false;
            let correctCount = 0;
            let incorrectCount = 0;
            let noteMistakes = {};
            let nextPracticeNote = null;
            let lastFocusedElement;
            
            // --- Performance & UI Caching ---
            const highlightDot = document.createElement('div');
            highlightDot.id = 'highlight-dot';

            // --- Audio & Pitch Detection Logic ---
            const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            
            function setupAudio() {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
            }

            function playTick(isCountIn = false) {
                const tickCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = tickCtx.createOscillator();
                const gainNode = tickCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(tickCtx.destination);
                oscillator.type = isCountIn ? 'sine' : 'triangle';
                oscillator.frequency.setValueAtTime(isCountIn ? 440 : 880, tickCtx.currentTime);
                gainNode.gain.setValueAtTime(0.4, tickCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, tickCtx.currentTime + 0.05);
                oscillator.start(tickCtx.currentTime);
                oscillator.stop(tickCtx.currentTime + 0.05);
                setTimeout(() => tickCtx.close(), 100);
            }
            
            function noteFromPitch(frequency) {
                const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
                return noteStrings[Math.round(noteNum + 69) % 12];
            }

            function autoCorrelate(buf, sampleRate) {
                const SIZE = buf.length;
                let rms = 0;
                for (let i = 0; i < SIZE; i++) {
                    const val = buf[i];
                    rms += val * val;
                }
                rms = Math.sqrt(rms / SIZE);
                if (rms < 0.02) return -1;

                let r1 = 0, r2 = SIZE - 1, thres = 0.2;
                for (let i = 0; i < SIZE / 2; i++) {
                    if (Math.abs(buf[i]) < thres) { r1 = i; break; }
                }
                for (let i = 1; i < SIZE / 2; i++) {
                    if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
                }

                buf = buf.slice(r1, r2);
                const newSize = buf.length;
                const c = new Array(newSize).fill(0);
                for (let i = 0; i < newSize; i++) {
                    for (let j = 0; j < newSize - i; j++) {
                        c[i] = c[i] + buf[j] * buf[j + i];
                    }
                }

                let d = 0;
                while (d < c.length && c[d] > c[d + 1]) d++;
                let maxval = -1, maxpos = -1;
                for (let i = d; i < c.length; i++) {
                    if (c[i] > maxval) {
                        maxval = c[i];
                        maxpos = i;
                    }
                }
                let T0 = maxpos;

                const x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
                const a = (x1 + x3 - 2 * x2) / 2;
                const b = (x3 - x1) / 2;
                if (a) T0 = T0 - b / (2 * a);

                return sampleRate / T0;
            }
            
            function runPitchDetection() {
                if (!isPitchDetectionRunning) return;
                const buffer = new Float32Array(analyser.fftSize);
                analyser.getFloatTimeDomainData(buffer);
                const fundamental = autoCorrelate(buffer, audioCtx.sampleRate);
                
                if (fundamental !== -1) {
                    const detectedNote = noteFromPitch(fundamental);
                    detectedNoteEl.textContent = detectedNote;
                    const targetNote = practiceNoteContainer.querySelector('.current-practice-note').textContent;
                    
                    if(detectedNote === targetNote) {
                        tunerDisplay.classList.add('correct');
                        detectedNoteEl.textContent = "Correct!";
                    } else {
                        tunerDisplay.classList.remove('correct');
                    }

                } else {
                    detectedNoteEl.textContent = "--";
                     tunerDisplay.classList.remove('correct');
                }
                pitchDetectionFrameId = requestAnimationFrame(runPitchDetection);
            }

            async function toggleMicInput(enable) {
                if (enable) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        micStream = stream;
                        setupAudio();
                        analyser = audioCtx.createAnalyser();
                        analyser.fftSize = 2048;
                        const source = audioCtx.createMediaStreamSource(stream);
                        source.connect(analyser);
                        tunerDisplay.classList.remove('hidden');
                        isPitchDetectionRunning = true;
                        runPitchDetection();
                    } catch (err) {
                        console.error("Microphone access error:", err);
                        alert("Microphone access denied. Please allow microphone access in your browser settings.");
                        micEnableToggle.checked = false;
                    }
                } else {
                    isPitchDetectionRunning = false;
                    cancelAnimationFrame(pitchDetectionFrameId);
                    if(micStream) {
                        micStream.getTracks().forEach(track => track.stop());
                        micStream = null;
                    }
                    if(audioCtx && audioCtx.state !== 'closed') {
                         audioCtx.suspend();
                    }
                    tunerDisplay.classList.add('hidden');
                }
            }


            // --- UI Creation ---
            function createFretboard() {
                fretboardEl.innerHTML = '';
                fretNumbersEl.innerHTML = '';
                
                const gridTemplate = `5% repeat(${FRET_COUNT}, 1fr)`; 
                fretboardEl.style.gridTemplateColumns = gridTemplate;
                fretNumbersEl.style.gridTemplateColumns = gridTemplate;
                const stringThickness = [1, 1.2, 1.5, 1.8, 2.1, 2.4];

                for (let i = 0; i < tuning.length; i++) {
                    for (let j = 0; j <= FRET_COUNT; j++) {
                        const fretEl = document.createElement('div');
                        fretEl.classList.add('fret', 'relative', 'flex', 'items-center', 'justify-center', 'h-12');
                        fretEl.dataset.string = i;
                        fretEl.dataset.fret = j;
                        const stringLine = document.createElement('div');
                        stringLine.classList.add('string-line', 'w-full', 'absolute');
                        stringLine.style.height = `${stringThickness[i]}px`;
                        fretEl.appendChild(stringLine);
                        fretboardEl.appendChild(fretEl);
                    }
                }
                const markers = { 3: [2], 5: [2], 7: [2], 9: [2], 12: [1, 3] };
                for (const fret in markers) {
                    markers[fret].forEach(stringIndex => {
                         const targetFret = fretboardEl.querySelector(`.fret[data-string='${stringIndex}'][data-fret='${fret}']`);
                         if(targetFret) {
                            const markerDot = document.createElement('div');
                            markerDot.classList.add('marker-dot', 'absolute', 'w-5', 'h-5', 'rounded-full', 'left-1/2', 'z-0');
                            markerDot.style.top = '100%';
                            markerDot.style.transform = 'translate(-50%, -50%)';
                            targetFret.appendChild(markerDot);
                         }
                    });
                }
                
                const emptyFretDiv = document.createElement('div');
                fretNumbersEl.appendChild(emptyFretDiv); 
                for (let j = 1; j <= FRET_COUNT; j++) {
                    const fretNumEl = document.createElement('div');
                    fretNumEl.classList.add('relative', 'flex', 'justify-center', 'text-sm');
                    fretNumEl.style.color = 'var(--text-light)';
                    if ([3, 5, 7, 9, 12].includes(j)) {
                        fretNumEl.textContent = j;
                    }
                    fretNumbersEl.appendChild(fretNumEl);
                }
                
                fretboardContainer.appendChild(highlightDot);
                highlightDot.style.display = 'none';
            }

            function createTabView() {
                tabContainer.innerHTML = '';
                tuning.forEach((stringName, stringIndex) => {
                    const stringEl = document.createElement('div');
                    stringEl.classList.add('tab-string');
                    stringEl.dataset.stringIndex = stringIndex;
                    stringEl.innerHTML = `
                        <span class="w-4" style="color: var(--text-light);">${stringName}</span>
                        <span>|--</span>
                        <span class="tab-fret-number w-8 h-8 flex items-center justify-center">-</span>
                        <span>--|</span>
                    `;
                    tabContainer.appendChild(stringEl);
                });
            }

            // --- Core Logic ---
            function getNote(stringIndex, fretNumber) {
                const openNote = tuning[stringIndex];
                const openNoteIndex = notes.indexOf(openNote);
                const noteIndex = (openNoteIndex + fretNumber) % 12;
                return notes[noteIndex];
            }
            
            function drawBeatDots() {
                beatDotsContainer.innerHTML = '';
                const duration = parseInt(noteDurationInput.value) || 1;
                const dotsToDraw = Math.min(duration, 16); 
                for (let i = 0; i < dotsToDraw; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('beat-dot', 'w-3', 'h-3', 'bg-gray-300', 'rounded-full');
                    beatDotsContainer.appendChild(dot);
                }
            }

            function updateActiveDot(beatIndex) {
                const dots = beatDotsContainer.children;
                if (!dots) return;
                for (let i = 0; i < dots.length; i++) {
                     dots[i].classList.toggle('active', i === beatIndex);
                     dots[i].classList.toggle('bg-gray-300', i !== beatIndex);
                }
            }

            function getActiveNotes() {
                if (naturalsOnlyToggle.checked) {
                    return notes.filter(n => !n.includes('#'));
                }
                const selectedNotes = Array.from(document.querySelectorAll('.note-select-checkbox:checked')).map(cb => cb.dataset.note);
                if (selectedNotes.length === 0) {
                    document.querySelectorAll('.note-select-checkbox').forEach(cb => cb.checked = true);
                    return notes;
                }
                return selectedNotes;
            }

            function getIntervalNote(currentNote, intervalType) {
                const currentNoteIndex = notes.indexOf(currentNote);
                if (currentNoteIndex === -1) return getActiveNotes()[0]; 

                let interval;
                switch (intervalType) {
                    case 'minorThirds': interval = 3; break;
                    case 'majorThirds': interval = 4; break;
                    case 'fourths': interval = 5; break;
                    case 'fifths': interval = 7; break;
                    case 'sevenths': interval = Math.random() < 0.5 ? 10 : 11; break;
                    default: return null;
                }
                const nextNoteIndex = (currentNoteIndex + interval) % 12;
                let nextNote = notes[nextNoteIndex];
                
                const activeNotes = getActiveNotes();
                if (!activeNotes.includes(nextNote)) {
                    return activeNotes[Math.floor(Math.random() * activeNotes.length)];
                }
                return nextNote;
            }

            function newQuestion() {
                const activeNotes = getActiveNotes();
                if (activeNotes.length === 0) {
                     feedbackEl.textContent = 'Please select at least one note to practice!';
                     return;
                }

                isAnswered = false;
                feedbackEl.textContent = '';
                highlightDot.style.display = 'none';
                
                if (currentModule === 'guessNote') {
                    if (currentView === 'fretboard' || currentView === 'tab') {
                        const targetNote = activeNotes[Math.floor(Math.random() * activeNotes.length)];
                        const occurrences = [];
                        for (let i = 0; i < tuning.length; i++) {
                            for (let j = 0; j <= FRET_COUNT; j++) {
                                if (getNote(i, j) === targetNote) {
                                    occurrences.push({ string: i, fret: j });
                                }
                            }
                        }
                        if (occurrences.length === 0) { newQuestion(); return; }
                        const { string: randomString, fret: randomFret } = occurrences[Math.floor(Math.random() * occurrences.length)];
                        correctAnswer = targetNote;
                        
                        if (currentView === 'fretboard') {
                            const targetFret = fretboardEl.querySelector(`.fret[data-string='${randomString}'][data-fret='${randomFret}']`);
                            if (targetFret) {
                                const fretRect = targetFret.getBoundingClientRect();
                                const containerRect = fretboardContainer.getBoundingClientRect();
                                highlightDot.style.left = `${fretRect.left - containerRect.left + (fretRect.width / 2) - 16}px`;
                                highlightDot.style.top = `${fretRect.top - containerRect.top + (fretRect.height / 2) - 16}px`;
                                highlightDot.style.display = 'block';
                            }
                        } else { // Tab view
                            tabContainer.querySelectorAll('.tab-fret-number').forEach(el => el.textContent = '-');
                            const targetStringEl = tabContainer.querySelector(`.tab-string[data-string-index='${randomString}'] .tab-fret-number`);
                            if (targetStringEl) {
                                targetStringEl.textContent = randomFret;
                            }
                        }

                        const options = new Set([correctAnswer]);
                         while (options.size < 4) {
                            options.add(notes[Math.floor(Math.random() * notes.length)]);
                        }
                        answerOptionsEl.innerHTML = '';
                        Array.from(options).sort(() => Math.random() - 0.5).forEach(note => {
                            const button = document.createElement('button');
                            button.textContent = note;
                            button.classList.add('p-4', 'border', 'hover:bg-gray-100', 'rounded-lg', 'text-lg', 'font-semibold', 'transition-colors', 'duration-200');
                            button.style.backgroundColor = 'var(--bg-light)';
                            button.style.borderColor = 'var(--border-color)';
                            button.dataset.note = note;
                            button.addEventListener('click', handleAnswer);
                            answerOptionsEl.appendChild(button);
                        });

                    } else if (currentView === 'noteToTab') {
                        const targetNote = activeNotes[Math.floor(Math.random() * activeNotes.length)];
                        noteToTabQuestionContainer.querySelector('.current-practice-note').textContent = targetNote;

                        const occurrences = [];
                        for (let i = 0; i < tuning.length; i++) {
                            for (let j = 1; j < FRET_COUNT; j++) {
                                if (getNote(i, j) === targetNote) {
                                    occurrences.push({ string: i, fret: j });
                                }
                            }
                        }
                        if (occurrences.length === 0) { newQuestion(); return; }
                        const correctOccurrence = occurrences[Math.floor(Math.random() * occurrences.length)];
                        correctAnswer = `${correctOccurrence.string}-${correctOccurrence.fret}`;

                        const options = new Set([correctAnswer]);
                        while(options.size < 4) {
                            const randomString = Math.floor(Math.random() * tuning.length);
                            const randomFret = Math.floor(Math.random() * 11) + 1;
                            const randomPosition = `${randomString}-${randomFret}`;
                            if (getNote(randomString, randomFret) !== targetNote) {
                                options.add(randomPosition);
                            }
                        }

                        answerOptionsEl.innerHTML = '';
                        Array.from(options).sort(() => Math.random() - 0.5).forEach(pos => {
                            const [string, fret] = pos.split('-');
                            const button = document.createElement('button');
                            button.innerHTML = `<span class="font-bold">${tuning[string]}</span> <span style="color:var(--text-light)">string</span> - <span class="font-bold">${fret}</span> <span style="color:var(--text-light)">fret</span>`;
                            button.classList.add('p-4', 'border', 'hover:bg-gray-100', 'rounded-lg', 'text-lg', 'transition-colors', 'duration-200');
                             button.style.backgroundColor = 'var(--bg-light)';
                            button.style.borderColor = 'var(--border-color)';
                            button.dataset.position = pos;
                            button.addEventListener('click', handleAnswer);
                            answerOptionsEl.appendChild(button);
                        });
                    }
                } else if (currentModule === 'playPractice') {
                    const currentNote = practiceNoteContainer.querySelector('.current-practice-note').textContent;
                    
                    if (nextPracticeNote === null || !activeNotes.includes(nextPracticeNote)) {
                        nextPracticeNote = activeNotes[Math.floor(Math.random() * activeNotes.length)];
                    }
                    
                    const newCurrentNote = nextPracticeNote;
                    practiceNoteContainer.querySelector('.current-practice-note').textContent = newCurrentNote;
                    
                    const intervalType = intervalSelect.value;
                    let newNextNote;
                    if (intervalType === 'random') {
                        const possibleNextNotes = activeNotes.filter(n => n !== newCurrentNote);
                        newNextNote = (possibleNextNotes.length > 0) ? possibleNextNotes[Math.floor(Math.random() * possibleNextNotes.length)] : newCurrentNote;
                    } else {
                        newNextNote = getIntervalNote(newCurrentNote, intervalType);
                    }
                    nextPracticeNote = newNextNote;
                    
                    nextPracticeNoteEl.textContent = nextPracticeNote;
                    drawBeatDots();
                    updateActiveDot(0);
                }
            }
            
            function updateStatsDisplay() {
                correctCountEl.textContent = correctCount;
                incorrectCountEl.textContent = incorrectCount;
            }

            function handleAnswer(e) {
                if (isAnswered) return;
                isAnswered = true;

                const allButtons = answerOptionsEl.querySelectorAll('button');
                allButtons.forEach(btn => { btn.disabled = true; });

                if (currentView === 'noteToTab') {
                    const selectedPosition = e.currentTarget.dataset.position;
                    if (selectedPosition === correctAnswer) {
                        correctCount++;
                        feedbackEl.textContent = 'Correct!';
                        feedbackEl.className = 'mt-6 h-10 text-2xl font-semibold transition-opacity duration-300 text-green-600';
                        e.currentTarget.classList.add('bg-green-100', 'border-green-400');
                    } else {
                        incorrectCount++;
                        const [string, fret] = correctAnswer.split('-');
                        noteMistakes[getNote(string, fret)] = (noteMistakes[getNote(string, fret)] || 0) + 1;
                        feedbackEl.innerHTML = `Wrong! Correct was <span class="font-bold">${tuning[string]} string - ${fret} fret</span>`;
                        feedbackEl.className = 'mt-6 h-10 text-xl font-semibold transition-opacity duration-300 text-red-600';
                        e.currentTarget.classList.add('bg-red-100', 'border-red-400');
                        allButtons.forEach(btn => {
                            if (btn.dataset.position === correctAnswer) {
                                btn.classList.add('bg-green-100', 'border-green-400');
                            }
                        });
                    }
                } else {
                    const selectedNote = e.currentTarget.dataset.note;
                    if (selectedNote === correctAnswer) {
                        correctCount++;
                        feedbackEl.textContent = 'Correct!';
                        feedbackEl.className = 'mt-6 h-10 text-2xl font-semibold transition-opacity duration-300 text-green-600';
                        e.currentTarget.classList.add('bg-green-100', 'border-green-400');
                    } else {
                        incorrectCount++;
                        noteMistakes[correctAnswer] = (noteMistakes[correctAnswer] || 0) + 1;
                        feedbackEl.textContent = `Wrong! The correct note was ${correctAnswer}`;
                        feedbackEl.className = 'mt-6 h-10 text-2xl font-semibold transition-opacity duration-300 text-red-600';
                        e.currentTarget.classList.add('bg-red-100', 'border-red-400');
                        allButtons.forEach(btn => {
                            if (btn.dataset.note === correctAnswer) {
                                btn.classList.add('bg-green-100', 'border-green-400');
                            }
                        });
                    }
                }
                
                updateStatsDisplay();
                if (!isMetronomeOn) {
                    setTimeout(newQuestion, 1200);
                }
            }

            // --- Metronome Logic ---
            function metronomeTick() {
                if (isCountingIn) {
                    playTick(true);
                    feedbackEl.textContent = `Starting in ${COUNT_IN_BEATS - countInCounter}...`;
                    feedbackEl.className = 'mt-6 h-10 text-2xl font-semibold transition-opacity duration-300 text-yellow-600';
                    countInCounter++;
                    if (countInCounter >= COUNT_IN_BEATS) {
                        isCountingIn = false;
                        noteTickCounter = 0;
                        newQuestion();
                    }
                    return;
                }

                playTick(false);
                speedUpTickCounter++;
                
                if (currentModule === 'playPractice') {
                    updateActiveDot(noteTickCounter);
                }

                if (speedUpToggle.checked) {
                    const speedInterval = parseInt(speedUpInterval.value) || 8;
                    if (speedUpTickCounter >= speedInterval) {
                        speedUpTickCounter = 0;
                        const amount = parseInt(speedUpAmount.value) || 5;
                        const currentBpm = parseInt(bpmSlider.value);
                        const newBpm = Math.min(parseInt(bpmSlider.max), currentBpm + amount);
                        if (newBpm !== currentBpm) {
                            bpmSlider.value = newBpm;
                            bpmDisplay.textContent = `${newBpm} BPM`;
                            clearInterval(metronomeIntervalId);
                            metronomeIntervalId = setInterval(metronomeTick, 60000 / newBpm);
                        }
                    }
                }

                const noteDuration = parseInt(noteDurationInput.value) || 1;
                if (noteTickCounter >= noteDuration - 1) {
                    if (currentModule === 'guessNote' && !isAnswered) {
                        incorrectCount++;
                        if (currentView === 'noteToTab') {
                            const [string, fret] = correctAnswer.split('-');
                             noteMistakes[getNote(string, fret)] = (noteMistakes[getNote(string, fret)] || 0) + 1;
                        } else {
                            noteMistakes[correctAnswer] = (noteMistakes[correctAnswer] || 0) + 1;
                        }
                        updateStatsDisplay();
                        feedbackEl.textContent = `Too slow!`;
                        feedbackEl.className = 'mt-6 h-10 text-2xl font-semibold transition-opacity duration-300 text-yellow-600';
                    }
                    newQuestion();
                    noteTickCounter = 0;
                } else {
                    noteTickCounter++;
                }
            }

            function toggleMetronome() {
                isMetronomeOn = !isMetronomeOn;
                if (isMetronomeOn) {
                    setupAudio();
                    metronomeBtn.textContent = 'Stop Metronome';
                    metronomeBtn.classList.replace('bg-blue-500', 'bg-red-500');
                    metronomeBtn.classList.replace('hover:bg-blue-600', 'hover:bg-red-600');
                    nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    nextBtn.disabled = true;
                    
                    isCountingIn = true;
                    countInCounter = 0;
                    speedUpTickCounter = 0;
                    
                    metronomeIntervalId = setInterval(metronomeTick, 60000 / parseInt(bpmSlider.value));
                    metronomeTick(); 
                } else {
                    clearInterval(metronomeIntervalId);
                    metronomeBtn.textContent = 'Start Metronome';
                    metronomeBtn.classList.replace('bg-red-500', 'bg-blue-500');
                    metronomeBtn.classList.replace('hover:bg-red-600', 'hover:bg-blue-600');
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    nextBtn.disabled = false;
                    isCountingIn = false;
                    feedbackEl.textContent = '';
                    if (currentModule === 'playPractice') {
                        updateActiveDot(-1);
                    }
                }
            }
            
            // --- UI Management & Accessibility ---
            function trapFocusInModal(e) {
                const focusableElements = statsModal.querySelectorAll('button');
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                if (e.key === 'Tab') {
                    if (e.shiftKey && document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    } else if (!e.shiftKey && document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            }

            function displayDetailedStats() {
                lastFocusedElement = document.activeElement;
                statsContentEl.innerHTML = '';
                const sortedMistakes = Object.entries(noteMistakes).sort((a, b) => b[1] - a[1]);

                if (sortedMistakes.length === 0) {
                    statsContentEl.innerHTML = `<p class="text-center" style="color:var(--text-light)">No mistakes! Great job!</p>`;
                } else {
                    const list = document.createElement('ul');
                    list.className = 'space-y-3';
                    sortedMistakes.forEach(([note, count]) => {
                        const item = document.createElement('li');
                        item.className = 'flex justify-between items-center p-3 rounded-lg';
                        item.style.backgroundColor = 'var(--bg-panel)';
                        item.innerHTML = `
                            <span class="font-bold text-lg" style="color:var(--text-dark)">${note}</span>
                            <span class="text-red-600">${count} ${count > 1 ? 'mistakes' : 'mistake'}</span>
                        `;
                        list.appendChild(item);
                    });
                    statsContentEl.appendChild(list);
                }
                statsModalOverlay.classList.remove('hidden');
                closeStatsBtn.focus();
                statsModalOverlay.addEventListener('keydown', trapFocusInModal);
            }
            
            function closeStatsModal() {
                 statsModalOverlay.classList.add('hidden');
                 statsModalOverlay.removeEventListener('keydown', trapFocusInModal);
                 if (lastFocusedElement) {
                    lastFocusedElement.focus();
                 }
            }
            
            function setModule(moduleName) {
                currentModule = moduleName;
                moduleSwitchBtns.forEach(btn => {
                    const isActive = btn.dataset.module === moduleName;
                    btn.classList.toggle('active', isActive);
                    btn.setAttribute('aria-selected', isActive);
                });

                const isGuessNote = moduleName === 'guessNote';
                viewSwitcherContainer.classList.toggle('hidden', !isGuessNote);
                statsDisplay.classList.toggle('hidden', !isGuessNote);
                statsBtn.classList.toggle('hidden', !isGuessNote);
                practiceNoteContainer.classList.toggle('hidden', isGuessNote);
                practiceSettingsContainer.classList.toggle('hidden', isGuessNote);
                
                setView(isGuessNote ? currentView : 'none');
                
                beatDotsContainer.innerHTML = '';
                feedbackEl.textContent = '';
                
                newQuestion();
            }

            function setView(viewName) {
                if (viewName !== 'none') {
                    currentView = viewName;
                    viewSwitchBtns.forEach(btn => {
                        const isActive = btn.dataset.view === viewName;
                        btn.classList.toggle('active', isActive);
                        btn.setAttribute('aria-selected', isActive);
                    });
                }

                fretboardContainer.classList.toggle('hidden', viewName !== 'fretboard');
                tabContainer.classList.toggle('hidden', viewName !== 'tab');
                noteToTabQuestionContainer.classList.toggle('hidden', viewName !== 'noteToTab');
                answerOptionsEl.classList.toggle('hidden', currentModule !== 'guessNote');

                newQuestion();
            }
            
            function populateNoteSelection() {
                noteSelectionGrid.innerHTML = '';
                notes.forEach(note => {
                    const container = document.createElement('div');
                    container.classList.add('flex', 'items-center', 'gap-2');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `note-check-${note.replace('#', 's')}`;
                    checkbox.dataset.note = note;
                    checkbox.checked = true;
                    const label = document.createElement('label');
                    label.htmlFor = `note-check-${note.replace('#', 's')}`;
                    label.textContent = note;
                    label.classList.add('font-medium');
                    container.appendChild(checkbox);
                    container.appendChild(label);
                    noteSelectionGrid.appendChild(container);
                });
            }

            // --- Initialization & Event Listeners ---
            
            function applyStoredSettings() {
                const isDark = localStorage.getItem('darkMode') === 'true';
                bodyEl.classList.toggle('dark', isDark);
                darkModeToggle.checked = isDark;
                const isLefty = localStorage.getItem('leftyMode') === 'true';
                bodyEl.classList.toggle('lefty', isLefty);
                leftyToggle.checked = isLefty;
            }

            populateNoteSelection();
            applyStoredSettings();
            
            naturalsOnlyToggle.addEventListener('change', () => {
                const isChecked = naturalsOnlyToggle.checked;
                document.querySelectorAll('.note-select-checkbox').forEach(cb => {
                    cb.disabled = isChecked;
                    cb.parentElement.classList.toggle('opacity-50', isChecked);
                });
                if (!isMetronomeOn) newQuestion();
            });

            document.querySelectorAll('.note-select-checkbox').forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!isMetronomeOn) newQuestion();
                });
            });

            settingsToggleBtn.addEventListener('click', () => {
                bodyEl.classList.toggle('panel-visible');
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    toggleMetronome();
                }
                
                if (['1', '2', '3', '4'].includes(e.key) && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    const buttons = answerOptionsEl.querySelectorAll('button');
                    const index = parseInt(e.key) - 1;
                    if (buttons[index] && !buttons[index].disabled) {
                        buttons[index].click();
                    }
                }
                
                if(e.key === 'Escape' && !statsModalOverlay.classList.contains('hidden')) {
                    closeStatsModal();
                }
            });

            bpmSlider.addEventListener('input', (e) => {
                bpmDisplay.textContent = `${e.target.value} BPM`;
                if (isMetronomeOn && !isCountingIn) {
                    clearInterval(metronomeIntervalId);
                    metronomeIntervalId = setInterval(metronomeTick, 60000 / parseInt(e.target.value));
                }
            });
            noteDurationInput.addEventListener('input', () => {
                if (currentModule === 'playPractice' && !isMetronomeOn) {
                    drawBeatDots();
                    updateActiveDot(-1);
                }
            });
            speedUpToggle.addEventListener('change', (e) => {
                speedUpControls.classList.toggle('max-h-0', !e.target.checked);
                speedUpControls.classList.toggle('opacity-0', !e.target.checked);
                speedUpControls.classList.toggle('max-h-40', e.target.checked);
                speedUpControls.classList.toggle('opacity-100', e.target.checked);
            });
            metronomeBtn.addEventListener('click', toggleMetronome);
            nextBtn.addEventListener('click', newQuestion);
            statsBtn.addEventListener('click', displayDetailedStats);
            closeStatsBtn.addEventListener('click', closeStatsModal);
            statsModalOverlay.addEventListener('click', (e) => {
                if (e.target === statsModalOverlay) {
                    closeStatsModal();
                }
            });
            moduleSwitchBtns.forEach(btn => {
                btn.addEventListener('click', () => setModule(btn.dataset.module));
            });
            viewSwitchBtns.forEach(btn => {
                btn.addEventListener('click', () => setView(btn.dataset.view));
            });
             micEnableToggle.addEventListener('change', (e) => {
                toggleMicInput(e.target.checked);
            });
            darkModeToggle.addEventListener('change', (e) => {
                bodyEl.classList.toggle('dark', e.target.checked);
                localStorage.setItem('darkMode', e.target.checked);
            });
            leftyToggle.addEventListener('change', (e) => {
                bodyEl.classList.toggle('lefty', e.target.checked);
                localStorage.setItem('leftyMode', e.target.checked);
            });

            createFretboard();
            createTabView();
            setModule('guessNote'); // Initial setup
        });
    </script>
</body>
</html>

