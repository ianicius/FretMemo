import{e as ye,f as vs,j as e,g as w,r as l,N as te,b as me,B as S,X as It,a as Et,d as _t,E as ws,C as ks,T as $t,h as Ss,F as Lt,S as Cs,u as Ts,i as Ms,c as re,n as As,k as Ps,l as ot}from"./index-8k3NHg1O.js";import{L as U,S as Me,a as Ne,F as St}from"./label-CK7aOXpE.js";import{C as be,a as Rs,b as Fs}from"./card-DHuo3zQd.js";import{D as zt,a as Bt,b as Ot,c as Dt,d as Ht,H as Is,R as Es,T as Ct,e as Tt,f as Te}from"./dialog-CzfZG62x.js";import{B as _s}from"./badge-dDcdEKhE.js";import{S as $s,a as Mt}from"./square-Ci3b_MbC.js";import{C as Ls}from"./chevron-down-KnoLXRSR.js";import{Z as it}from"./zap-X4QqOg3m.js";import{P as ct}from"./play-Cg0uJj4I.js";import{M as zs}from"./mastery-bar-DpVvEAwv.js";import{C as Bs}from"./clock-BksrT6E4.js";const Os=[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]],Ds=ye("arrow-up-right",Os);const Hs=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],Us=ye("map",Hs);const Gs=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],Ut=ye("mic",Gs);const qs=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]],Vs=ye("pause",qs);const Xs=[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]],Ks=ye("timer",Xs);const Ws=[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72",key:"ul74o6"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]],At=ye("wand-sparkles",Ws);function Oe({tuning:n=vs,position:d,leftHanded:a=!1,className:f}){const r=a?n.map((s,p)=>({openNote:s,stringIndex:n.length-1-p})):n.map((s,p)=>({openNote:s,stringIndex:p}));return e.jsx("div",{className:w("w-full max-w-md mx-auto",f),children:e.jsx("div",{className:"rounded-2xl border border-border/60 bg-card/40 shadow-sm px-4 py-5",children:e.jsx("div",{className:"space-y-2 font-mono text-sm",children:r.map(({openNote:s,stringIndex:p})=>{const i=!!(d&&d.stringIndex===p),h=i&&d?String(d.fret):"-";return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-8 text-muted-foreground font-semibold",children:s}),e.jsx("span",{className:"text-muted-foreground",children:"|--"}),e.jsx("span",{className:w("w-10 text-center font-bold tabular-nums rounded-md border px-1 py-0.5",i?"border-primary/40 bg-primary/10 text-primary":"border-border/40 bg-muted/20 text-muted-foreground"),children:h}),e.jsx("span",{className:"text-muted-foreground",children:"--|"})]},`${s}-${p}`)})})})})}function Ys(n,d){let a=0;for(let c=0;c<n.length;c++){const N=n[c];a+=N*N}if(a=Math.sqrt(a/n.length),a<.01)return null;let f=0,r=n.length-1;const s=.2;for(;f<n.length/2&&Math.abs(n[f])<s;)f++;for(;r>n.length/2&&Math.abs(n[r])<s;)r--;const p=n.slice(f,r);if(p.length<2)return null;const i=p.length,h=new Float32Array(i);for(let c=0;c<i;c++){let N=0;for(let k=0;k<i-c;k++)N+=p[k]*p[k+c];h[c]=N}let y=0;for(;y<i-1&&h[y]>h[y+1];)y++;let u=y,C=-1/0;for(let c=y;c<i;c++){const N=h[c];N>C&&(C=N,u=c)}if(u<=0)return null;let x=u;if(u>0&&u<i-1){const c=h[u-1],N=h[u],k=h[u+1],P=(c+k-2*N)/2,E=(k-c)/2;P!==0&&(x=u-E/(2*P))}const m=d/x;return Number.isFinite(m)?m:null}function Zs(n){const a=(Math.round(12*Math.log2(n/440)+69)%12+12)%12;return te[a]}function Js(n,d={}){const{minHz:a=70,maxHz:f=1200,stableFrames:r=3}=d,[s,p]=l.useState(null),[i,h]=l.useState(null),[y,u]=l.useState(null),[C,x]=l.useState(!1),m=l.useRef(null),c=l.useRef(null),N=l.useRef(null),k=l.useRef(null),P=l.useRef({note:null,count:0}),E=l.useCallback(()=>{k.current!==null&&(cancelAnimationFrame(k.current),k.current=null),c.current=null,N.current&&(N.current.getTracks().forEach(b=>b.stop()),N.current=null),m.current&&(m.current.close().catch(()=>{}),m.current=null),P.current={note:null,count:0},x(!1),h(null),p(null)},[]),_=l.useCallback(async()=>{if(u(null),!navigator.mediaDevices?.getUserMedia){u("Microphone input is not supported in this browser.");return}try{const b=await navigator.mediaDevices.getUserMedia({audio:!0});N.current=b;const A=window.AudioContext||window.webkitAudioContext;if(!A)throw new Error("AudioContext is not available in this environment.");const R=new A;m.current=R,R.state==="suspended"&&await R.resume();const M=R.createAnalyser();M.fftSize=2048,c.current=M,R.createMediaStreamSource(b).connect(M),x(!0);const $=new Float32Array(M.fftSize),D=()=>{const ae=m.current,ne=c.current;if(!ae||!ne)return;ne.getFloatTimeDomainData($);const V=Ys($,ae.sampleRate);if(V&&V>=a&&V<=f){const oe=Zs(V);P.current.note===oe?P.current.count+=1:P.current={note:oe,count:1},P.current.count>=r&&(h(V),p(oe))}else P.current={note:null,count:0},h(null),p(null);k.current=requestAnimationFrame(D)};D()}catch{E(),u("Microphone access denied. Allow mic permission to use pitch detection.")}},[f,a,r,E]);return l.useEffect(()=>{if(n)return _(),()=>E()},[n,_,E]),{note:s,frequency:i,error:y,isRunning:C}}const Qs={fretboardToNote:{label:"Fretboard → Note",description:"Identify notes on the fretboard."},tabToNote:{label:"Tab → Note",description:"Read tablature and identify notes."},noteToTab:{label:"Note → Tab",description:"Find the right position for each note."},playNotes:{label:"Note Names (Mic)",description:"Play the prompted note on your guitar."},playTab:{label:"Tab Sequence (Mic)",description:"Play tab prompts with microphone detection."}},Pt=new Set(["full-neck","open-major","a-minor-pent"]),er=[{id:"major",label:"Major"},{id:"minor",label:"Minor"},{id:"majorPentatonic",label:"Major Pentatonic"},{id:"minorPentatonic",label:"Minor Pentatonic"}],tr=[{id:"full-neck",label:"Full Neck",values:{fretRange:{min:1,max:12},noteFilter:"all"}},{id:"open-major",label:"Open Major",values:{fretRange:{min:1,max:5},rootNote:"C",scaleType:"major",noteFilter:"all"}},{id:"a-minor-pent",label:"A Minor Pent",values:{fretRange:{min:5,max:8},rootNote:"A",scaleType:"minorPentatonic",noteFilter:"all"}},{id:"naturals",label:"Naturals",values:{noteFilter:"naturals"}}];function sr({isOpen:n,onClose:d,onStart:a,mode:f,bpm:r,onBpmChange:s,noteDuration:p,onNoteDurationChange:i,isMetronomeOn:h,onMetronomeToggle:y,fretRange:u,tuning:C,onFretRangeChange:x,enabledStrings:m,onStringToggle:c,noteFilter:N,onNoteFilterChange:k,rootNote:P,onRootNoteChange:E,scaleType:_,onScaleTypeChange:b,onApplyPreset:A}){const R=Qs[f],[M,O]=l.useState(!1),$=l.useMemo(()=>Array.from({length:C.length},()=>!0),[C.length]),D=l.useMemo(()=>C.map((o,L)=>L===0?o.toLowerCase():o),[C]),ae=me(o=>o.speedUpEnabled),ne=me(o=>o.speedUpAmount),V=me(o=>o.speedUpInterval),oe=me(o=>o.setSpeedUpEnabled),Pe=me(o=>o.setSpeedUpAmount),Re=me(o=>o.setSpeedUpInterval),Fe=o=>{const L=o.values;return!(L.fretRange&&(L.fretRange.min!==u.min||L.fretRange.max!==u.max)||Pt.has(o.id)&&!$.every((dt,Ie)=>!!m[Ie])||L.noteFilter&&L.noteFilter!==N||L.rootNote&&L.rootNote!==P||L.scaleType&&L.scaleType!==_)};return e.jsx(zt,{open:n,onOpenChange:o=>!o&&d(),children:e.jsxs(Bt,{className:"flex max-h-[90vh] flex-col overflow-hidden p-0 sm:max-w-md",children:[e.jsx(Ot,{className:"shrink-0 border-b border-border/50 px-6 py-4 pr-12",children:e.jsxs(Dt,{className:"text-left",children:[e.jsx("div",{className:"text-base font-semibold",children:"Session Setup"}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx(_s,{variant:"secondary",children:R.label}),e.jsx("span",{className:"text-xs font-normal text-muted-foreground",children:R.description})]})]})}),e.jsxs("div",{className:"flex-1 space-y-6 overflow-y-auto px-6 py-4",children:[e.jsxs("section",{className:"space-y-3 rounded-lg border border-border/50 p-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(U,{className:"text-sm",children:"Tempo"}),e.jsxs("span",{className:"font-mono text-xs text-muted-foreground",children:[r," BPM"]})]}),e.jsx(Me,{value:[r],onValueChange:([o])=>s(o),min:30,max:280,step:1})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-sm",children:"Metronome"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Use click track while practicing."})]}),e.jsx(Ne,{checked:h,onCheckedChange:o=>{o!==h&&y()}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{className:"text-sm",children:"Quick Presets"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:tr.map(o=>e.jsx(S,{type:"button",size:"sm",variant:Fe(o)?"secondary":"outline",className:w("h-8 text-xs",Fe(o)&&"border-primary/40"),onClick:()=>A(Pt.has(o.id)?{...o.values,enabledStrings:$}:o.values),children:o.label},o.id))})]})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsxs(S,{type:"button",variant:"ghost",className:"h-auto w-full justify-between rounded-lg border border-dashed border-border px-3 py-2",onClick:()=>O(o=>!o),children:[e.jsxs("span",{className:"inline-flex items-center gap-2 text-sm font-medium",children:[e.jsx($s,{className:"h-4 w-4"}),"Advanced"]}),e.jsx(Ls,{className:w("h-4 w-4 transition-transform",M&&"rotate-180")})]}),M&&e.jsxs("div",{className:"space-y-4 rounded-lg border border-border/50 p-3",children:[h&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(U,{className:"text-sm",children:"Note Duration"}),e.jsx("span",{className:"font-mono text-xs text-muted-foreground",children:p})]}),e.jsx(Me,{value:[p],onValueChange:([o])=>i(o),min:1,max:16,step:1})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(U,{className:"text-sm",children:"Fret Range"}),e.jsxs("span",{className:"font-mono text-xs text-muted-foreground",children:[u.min," - ",u.max]})]}),e.jsx(Me,{value:[u.min,u.max],onValueChange:o=>{if(o.length<2)return;const L=Math.min(o[0],o[1]),Y=Math.max(o[0],o[1]);x({min:L,max:Y})},min:1,max:12,step:1})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{className:"text-sm",children:"Strings"}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:`repeat(${Math.max(1,Math.min(8,C.length))}, minmax(0, 1fr))`},children:D.map((o,L)=>{const Y=!!m[L];return e.jsx(S,{type:"button",size:"sm",variant:Y?"secondary":"outline",className:"h-8 px-0 text-xs",onClick:()=>c(L),children:o},`${o}-${L}`)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{className:"text-sm",children:"Notes"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(S,{type:"button",size:"sm",variant:N==="all"?"secondary":"outline",onClick:()=>k("all"),children:"All Notes"}),e.jsx(S,{type:"button",size:"sm",variant:N==="naturals"?"secondary":"outline",onClick:()=>k("naturals"),children:"Naturals"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{className:"text-sm",children:"Root Note"}),e.jsx("select",{className:"flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm",value:P,onChange:o=>E(o.target.value),children:te.map(o=>e.jsx("option",{value:o,children:o},o))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{className:"text-sm",children:"Scale Type"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:er.map(o=>e.jsx(S,{type:"button",size:"sm",variant:_===o.id?"secondary":"outline",className:"h-8 text-xs",onClick:()=>b(o.id),children:o.label},o.id))})]}),h&&e.jsxs("div",{className:"space-y-3 rounded-md border border-amber-300/40 bg-amber-50/60 p-3 dark:border-amber-500/20 dark:bg-amber-900/10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx(it,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-sm font-medium",children:"Auto Speed-Up"})]}),e.jsx(Ne,{checked:ae,onCheckedChange:oe})]}),ae&&e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(U,{className:"text-xs",children:"Increase"}),e.jsx("input",{type:"number",value:ne,onChange:o=>Pe(parseInt(o.target.value,10)||5),min:1,max:20,className:"h-8 w-full rounded-md border border-input bg-background px-2 text-center text-sm"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(U,{className:"text-xs",children:"Every X beats"}),e.jsx("input",{type:"number",value:V,onChange:o=>Re(parseInt(o.target.value,10)||8),min:1,max:32,className:"h-8 w-full rounded-md border border-input bg-background px-2 text-center text-sm"})]})]})]})]})]})]}),e.jsxs(Ht,{className:"shrink-0 gap-2 border-t border-border/50 bg-background px-6 py-4",children:[e.jsxs(S,{variant:"outline",onClick:d,className:"flex-1",children:[e.jsx(It,{className:"mr-2 h-4 w-4"}),"Cancel"]}),e.jsxs(S,{onClick:a,className:"flex-1 control-btn--primary",children:[e.jsx(ct,{className:"mr-2 h-4 w-4"}),"Start"]})]})]})})}function Rt(n){const d=Math.floor(n/60),a=n%60;return`${d}:${a.toString().padStart(2,"0")}`}function rr({isOpen:n,onClose:d,onRestart:a,onFocusWeakSpots:f,stats:r,xpEarned:s}){const p=Et(b=>b.positionStats);if(!r)return null;const i=r.correct+r.incorrect,h=i>0?Math.round(r.correct/i*100):0,y=r.previousAccuracy===null?null:h-r.previousAccuracy,u=s>0?s:5,C=Object.entries(p).filter(([,b])=>b.total>=3).sort((b,A)=>b[1].correct/b[1].total-A[1].correct/A[1].total)[0],x=C?(()=>{const[b,A]=C,[R,M]=b.split("-").map(Number),O=Math.round(A.correct/A.total*100);return`Focus string ${R+1}, fret ${M} (${O}% accuracy).`})():"Try a focused drill on one string range.",m=r.isFirstSession?"first_session":h===0?"zero_accuracy":r.personalBest?"personal_best":y!==null&&y>=0?"improved":h<50?"low_accuracy":"decent_but_down",c=m==="first_session"?"First session complete. Every note attempt builds your fretboard map.":m==="zero_accuracy"?`You practiced for ${Rt(r.duration)} and attempted ${i} notes. ${x}`:m==="low_accuracy"?`${r.incorrect} notes to review this run. ${x}`:m==="decent_but_down"?"Slightly below your previous session. A focused follow-up should recover momentum.":m==="personal_best"?"New personal best. Keep this pace and lock it in.":"Solid improvement from your previous session.",N=m==="personal_best"?"Personal best energy. If FretMemo helped you get here, a coffee tip helps fund the next drill and polish pass. No pressure.":m==="first_session"?"If this felt helpful, buying me a coffee helps me keep shipping drills, fixes, and articles. No pressure.":"If this session was helpful, buying me a coffee helps fund new drills, fixes, and polish. No pressure.",k=[r.correct>0?{label:"Correct",value:`${r.correct}`}:null,r.incorrect>0?{label:"Notes to review",value:`${r.incorrect}`}:null,r.maxStreak>0?{label:"Best streak",value:`${r.maxStreak}`}:null,r.score>0?{label:"Score",value:`${r.score}`}:null,{label:"You practiced",value:Rt(r.duration)},{label:"XP earned",value:`+${u}`}].filter(b=>!!b),P=m==="first_session"||m==="zero_accuracy",E=m==="zero_accuracy"||m==="low_accuracy",_=m!=="first_session"&&m!=="personal_best";return e.jsx(zt,{open:n,onOpenChange:b=>!b&&d(),children:e.jsxs(Bt,{className:"sm:max-w-xl",children:[e.jsx(Ot,{children:e.jsxs(Dt,{className:"flex items-center justify-center gap-2 text-center",children:[e.jsx(_t,{className:"h-6 w-6 text-primary"}),"Session Complete"]})}),e.jsxs("div",{className:"space-y-4 py-2",children:[!P&&e.jsxs("div",{className:"rounded-xl border border-border bg-muted/40 p-4 text-center",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:"Accuracy"}),e.jsxs("div",{className:"mt-1 text-4xl font-black text-foreground",children:[h,"%"]}),y!==null&&e.jsxs("div",{className:w("mt-1 inline-flex items-center gap-1 text-sm font-medium",y>=0?"text-emerald-600 dark:text-emerald-400":"text-rose-600 dark:text-rose-400"),children:[e.jsx(Ds,{className:w("h-4 w-4",y<0&&"rotate-90")}),y>=0?"+":"",y,"% vs previous session"]}),e.jsx("div",{className:"mt-3",children:e.jsx(zs,{value:h,showLabel:!1})}),m==="personal_best"&&e.jsx("p",{className:"mt-2 text-sm font-medium text-emerald-600 dark:text-emerald-400",children:"New personal best"})]}),e.jsxs("div",{className:"rounded-xl border border-border bg-card p-3 text-sm",children:[e.jsx("div",{className:"font-medium text-card-foreground",children:c}),P&&e.jsx("div",{className:"mt-2 text-muted-foreground",children:"The fretboard has 72 positions. Short, focused reps compound quickly."}),e.jsxs("div",{className:"mt-2 text-xs font-medium text-muted-foreground",children:["Participation bonus: +",u," XP"]}),e.jsxs("div",{className:"mt-3 rounded-lg border border-border/60 bg-muted/20 p-3",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Is,{className:"mt-0.5 h-4 w-4 text-primary"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-semibold text-card-foreground",children:"Enjoying FretMemo?"}),e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:N})]})]}),e.jsx("div",{className:"mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:e.jsx(S,{asChild:!0,className:"control-btn--primary w-full sm:w-auto",children:e.jsxs("a",{href:ws.buyMeCoffee,target:"_blank",rel:"noreferrer noopener",children:[e.jsx(ks,{className:"mr-2 h-4 w-4"}),"Buy me a coffee"]})})})]})]}),!P&&e.jsx("div",{className:"grid gap-2 text-sm sm:grid-cols-2",children:k.map(b=>e.jsx(ar,{label:b.label,value:b.value},b.label))})]}),e.jsxs(Ht,{className:"flex-col gap-2 sm:flex-row",children:[E&&_&&e.jsxs(S,{className:"w-full sm:w-auto control-btn--primary",variant:"default",onClick:f,children:[e.jsx(At,{className:"mr-2 h-4 w-4"}),"Focus Weak Spots"]}),e.jsxs(S,{className:w("w-full sm:w-auto",!E&&"control-btn--primary"),variant:E?"outline":"default",onClick:a,children:[e.jsx(Es,{className:"mr-2 h-4 w-4"}),"Practice Again"]}),!E&&_&&e.jsxs(S,{className:"w-full sm:w-auto",variant:"outline",onClick:f,children:[e.jsx(At,{className:"mr-2 h-4 w-4"}),"Focus Weak Spots"]}),e.jsxs(S,{variant:"outline",className:"w-full sm:w-auto",onClick:d,children:[e.jsx(It,{className:"mr-2 h-4 w-4"}),"Done"]})]})]})})}function ar({label:n,value:d}){return e.jsxs("div",{className:"flex items-center justify-between rounded-lg border border-border bg-card px-3 py-2",children:[e.jsx("span",{className:"text-muted-foreground",children:n}),e.jsx("span",{className:"font-mono font-semibold text-foreground",children:d})]})}function nr({isPlaying:n,score:d,streak:a,correct:f,incorrect:r,bpm:s,noteDuration:p,modeLabel:i,sessionStartTime:h,onPause:y,onResume:u,onStop:C,isPaused:x=!1,progressCurrent:m,progressTarget:c,onHeightChange:N}){const[k,P]=l.useState(0),E=l.useRef(null);l.useEffect(()=>{if(!n||!h||x)return;const M=setInterval(()=>{P(Math.floor((Date.now()-h)/1e3))},1e3);return()=>clearInterval(M)},[n,h,x]),l.useEffect(()=>{if(!N)return;const M=E.current;if(!M)return;const O=()=>{const D=Math.ceil(M.getBoundingClientRect().height);N(D)};if(O(),typeof ResizeObserver>"u"){window.requestAnimationFrame(O);return}const $=new ResizeObserver(O);return $.observe(M),()=>$.disconnect()},[N]);const _=f+r,b=_>0?Math.round(f/_*100):0,A=c&&c>0?Math.min(100,Math.round((m??_)/c*100)):null,R=M=>{const O=Math.floor(M/60),$=M%60;return`${O}:${$.toString().padStart(2,"0")}`};return x?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm",children:e.jsxs("div",{className:"text-center space-y-6",children:[e.jsx("div",{className:"text-6xl font-black text-muted-foreground/50",children:"PAUSED"}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsxs(S,{size:"lg",onClick:u,className:"control-btn--primary",children:[e.jsx(ct,{className:"w-5 h-5 mr-2"}),"Resume"]}),e.jsxs(S,{size:"lg",variant:"outline",onClick:C,className:"border-destructive text-destructive hover:bg-destructive/10",children:[e.jsx(Mt,{className:"w-5 h-5 mr-2 fill-current"}),"End Session"]})]})]})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:E,className:"fixed top-0 left-0 right-0 z-50 px-4 py-3",children:e.jsx("div",{className:"max-w-3xl mx-auto",children:e.jsxs("div",{className:"space-y-2 rounded-2xl border border-border/50 bg-card/90 px-4 py-2 shadow-lg backdrop-blur-md",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"hidden sm:block text-xs font-medium text-muted-foreground",children:i}),e.jsx("div",{className:"h-4 w-px bg-border hidden sm:block"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(Ks,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"font-mono font-medium",children:R(k)})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"hidden sm:flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Score"}),e.jsx("span",{className:"text-sm font-bold",children:d})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx($t,{className:"w-4 h-4 text-emerald-500"}),e.jsx("span",{className:"text-sm font-bold",children:f}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"/"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:_})]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsxs("span",{className:w("text-xs font-bold",b>=75?"text-emerald-500":b>=50?"text-amber-500":"text-rose-500"),children:[b,"%"]})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"hidden sm:flex items-center gap-1.5 text-xs text-muted-foreground mr-2",children:[e.jsx(it,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:a})]}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:y,children:e.jsx(Vs,{className:"w-4 h-4"})}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:C,children:e.jsx(Mt,{className:"w-4 h-4 fill-current"})})]})]}),A!==null&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between text-[10px] text-muted-foreground",children:[e.jsx("span",{children:"Session progress"}),e.jsxs("span",{className:"font-mono",children:[m??_,"/",c]})]}),e.jsx("div",{className:"h-1.5 overflow-hidden rounded-full bg-muted/50",children:e.jsx("div",{className:"h-full rounded-full bg-primary transition-all duration-300",style:{width:`${A}%`}})})]})]})})}),e.jsx("div",{className:"fixed bottom-4 left-0 right-0 z-50 px-4",children:e.jsx("div",{className:"max-w-md mx-auto",children:e.jsx("div",{className:"flex items-center justify-center gap-3 bg-card/80 backdrop-blur-sm border border-border/50 rounded-full px-4 py-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex gap-0.5",children:[...Array(8)].map((M,O)=>e.jsx("div",{className:w("w-1 h-4 rounded-full transition-all duration-150",O%4===0?"bg-primary":"bg-primary/40"),style:{animation:n?`pulse ${60/s}s ease-in-out infinite`:"none",animationDelay:`${O*(60/s/8)}s`}},O))}),e.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:[s," BPM • ",p," beat",p>1?"s":""]})]})})})}),e.jsx("style",{children:`
                @keyframes pulse {
                    0%, 100% { opacity: 0.4; transform: scaleY(0.8); }
                    50% { opacity: 1; transform: scaleY(1); }
                }
            `})]})}function or({xp:n,isVisible:d,onClose:a,streak:f=0,type:r="correct",message:s}){if(l.useEffect(()=>{if(!d)return;const N=setTimeout(()=>{a()},2500);return()=>{clearTimeout(N)}},[d,a]),!d)return null;const p={correct:{icon:Cs,iconBgColor:"bg-primary",iconTextColor:"text-primary-foreground",textColor:"text-primary",borderColor:"border-primary/30",bgGradient:"from-primary/20 to-primary/5",progressColor:"bg-primary",defaultMessage:"Correct!"},streak:{icon:Lt,iconBgColor:"bg-amber-500",iconTextColor:"text-white",textColor:"text-amber-600 dark:text-amber-300",borderColor:"border-amber-500/30",bgGradient:"from-amber-500/20 to-amber-500/5",progressColor:"bg-amber-500",defaultMessage:`${f} streak!`},achievement:{icon:_t,iconBgColor:"bg-emerald-500",iconTextColor:"text-white",textColor:"text-emerald-600 dark:text-emerald-300",borderColor:"border-emerald-500/30",bgGradient:"from-emerald-500/20 to-emerald-500/5",progressColor:"bg-emerald-500",defaultMessage:"Achievement Unlocked!"},levelup:{icon:it,iconBgColor:"bg-primary",iconTextColor:"text-primary-foreground",textColor:"text-primary",borderColor:"border-primary/30",bgGradient:"from-primary/20 to-primary/5",progressColor:"bg-primary",defaultMessage:"Level Up!"},warning:{icon:Ss,iconBgColor:"bg-rose-500",iconTextColor:"text-white",textColor:"text-rose-600 dark:text-rose-300",borderColor:"border-rose-500/30",bgGradient:"from-rose-500/20 to-rose-500/5",progressColor:"bg-rose-500",defaultMessage:"Streak lost"}},{icon:i,iconBgColor:h,iconTextColor:y,textColor:u,borderColor:C,bgGradient:x,progressColor:m,defaultMessage:c}=p[r];return e.jsxs("div",{className:"fixed top-20 left-1/2 -translate-x-1/2 z-[60] pointer-events-none",children:[e.jsxs("div",{className:w("relative flex items-center gap-3 px-4 py-3 rounded-xl border shadow-lg","bg-gradient-to-r",x,C,"animate-in slide-in-from-top-4 fade-in duration-300"),children:[e.jsx("div",{className:w("w-10 h-10 rounded-full flex items-center justify-center shrink-0",h),children:e.jsx(i,{className:w("w-5 h-5",y)})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-bold text-foreground",children:s||c}),n>0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("span",{className:w("text-lg font-black",u),children:["+",n]}),e.jsx("span",{className:"text-xs text-muted-foreground uppercase tracking-wider",children:"XP"})]})]}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-muted/40 rounded-b-xl overflow-hidden",children:e.jsx("div",{className:w("h-full rounded-full origin-left animate-[toastProgress_2.5s_linear_forwards]",m),style:{transformOrigin:"left center"}})})]}),e.jsx("style",{children:`
                @keyframes toastProgress {
                    from { transform: scaleX(0); }
                    to { transform: scaleX(1); }
                }
            `})]})}function lr({message:n,politeness:d="polite"}){const[a,f]=l.useState("");return l.useEffect(()=>{if(!n){f("");return}f("");const r=setTimeout(()=>f(n),50);return()=>clearTimeout(r)},[n]),e.jsx("div",{role:"status","aria-live":d,"aria-atomic":"true",className:"sr-only",children:a})}function ir({noteOptions:n,targetNote:d,selectedNote:a,isLocked:f,isCorrect:r,isPlaying:s,onSubmit:p}){return e.jsx("div",{className:"mx-auto grid max-w-[19.5rem] grid-cols-2 gap-2 min-[360px]:max-w-[21rem] min-[390px]:max-w-[22rem] min-[412px]:max-w-[23rem] min-[390px]:gap-2.5 sm:max-w-3xl sm:gap-3 sm:grid-cols-4",children:n.map((i,h)=>{const y=f&&i===d,u=f&&i===a,C=u&&!r;return e.jsx(S,{variant:"outline",className:w("h-11 rounded-lg border-2 px-2 text-base font-black transition-all shadow-sm hover:-translate-y-0.5 hover:border-primary hover:bg-primary/5 active:scale-95 active:bg-primary/10 min-[360px]:h-12 min-[390px]:h-[52px] min-[390px]:text-lg min-[412px]:h-14 sm:h-16 sm:rounded-2xl sm:text-2xl sm:hover:-translate-y-1",y&&"border-emerald-500 bg-emerald-500/10 text-emerald-700 dark:text-emerald-300",C&&"border-rose-500 bg-rose-500/10 text-rose-700 dark:text-rose-300"),disabled:!s||f,onClick:()=>p(i),"aria-pressed":f?u:void 0,"aria-label":`Answer ${i}`,children:i},`${i}-${h}`)})})}function cr({position:n,tuning:d,leftHanded:a=!1}){const f=a?d.map((r,s)=>({openNote:r,stringIndex:d.length-1-s})):d.map((r,s)=>({openNote:r,stringIndex:s}));return e.jsx("div",{className:"space-y-1 font-mono text-[10px] leading-none",children:f.map(({openNote:r,stringIndex:s})=>{const p=s===n.stringIndex;return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 text-muted-foreground font-semibold",children:r}),e.jsx("span",{className:"text-muted-foreground",children:"|--"}),e.jsx("span",{className:w("w-7 text-center font-bold tabular-nums rounded border px-1 py-0.5",p?"border-primary/40 bg-primary/10 text-primary":"border-transparent text-muted-foreground/50"),children:p?n.fret:"-"}),e.jsx("span",{className:"text-muted-foreground",children:"--|"})]},`${r}-${s}`)})})}function dr({options:n,targetPosition:d,lastAnswerPosition:a,isLocked:f,isCorrect:r,isPlaying:s,stringLabels:p,tuning:i,leftHanded:h,onSubmit:y}){return e.jsx("div",{className:"grid grid-cols-2 gap-2.5 min-[390px]:gap-3 sm:gap-4",children:n.map(u=>{const C=`${u.stringIndex}-${u.fret}`,x=f&&d&&u.stringIndex===d.stringIndex&&u.fret===d.fret,m=a&&u.stringIndex===a.stringIndex&&u.fret===a.fret;return e.jsx(S,{type:"button",variant:"outline",className:w("h-auto px-2.5 py-3 min-[390px]:px-3 min-[390px]:py-3.5 sm:px-6 sm:py-6 justify-start text-left rounded-xl sm:rounded-2xl border-2 transition-all relative overflow-hidden group","hover:border-primary/50 hover:bg-card/80",x&&"border-emerald-500 bg-emerald-500/10 text-emerald-700 dark:text-emerald-400 ring-2 ring-emerald-500/30",m&&!r&&"border-rose-500 bg-rose-500/10 text-rose-700 dark:text-rose-400 shake"),disabled:!s||f,onClick:()=>y(u),"aria-pressed":f?!!m:void 0,"aria-label":`${p[u.stringIndex]} string, fret ${u.fret}`,children:e.jsxs("div",{className:"w-full relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("span",{className:"text-sm font-bold tracking-wide uppercase text-muted-foreground group-hover:text-primary transition-colors",children:[p[u.stringIndex]," String"]}),e.jsxs("span",{className:"text-xs font-black font-mono bg-primary/10 text-primary px-3 py-1 rounded-full",children:["Fret ",u.fret]})]}),e.jsx("div",{className:"opacity-80 group-hover:opacity-100 transition-opacity scale-100 group-hover:scale-105 origin-left duration-300",children:e.jsx(cr,{position:u,tuning:i,leftHanded:h})})]})},C)})})}function mr({micEnabled:n,onMicChange:d}){return e.jsx("div",{className:"flex items-center justify-center gap-4",children:e.jsxs("div",{className:w("flex items-center gap-4 px-6 py-4 rounded-full border-2 transition-all duration-300",n?"bg-primary/5 border-primary/30":"bg-muted/30 border-border/50"),style:n?{boxShadow:"0 0 20px hsl(var(--primary) / 0.1)"}:void 0,children:[e.jsx(Ut,{className:w("w-6 h-6 transition-colors",n?"text-primary animate-pulse":"text-muted-foreground")}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(U,{htmlFor:"mic-toggle-focus",className:"text-sm font-bold cursor-pointer",children:"Microphone Input"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:n?"Listening...":"Click to enable"})]}),e.jsx(Ne,{id:"mic-toggle-focus",checked:n,onCheckedChange:d,className:"ml-2 scale-110"})]})})}function ur({onHint:n,hintUsed:d}){return e.jsx("div",{className:"flex justify-center",children:e.jsxs(S,{type:"button",variant:"outline",className:"rounded-full px-5 text-sm",onClick:n,disabled:d,children:["? Hint (",d?"used":"-5 pts",")"]})})}function xr({onNext:n}){return e.jsx("div",{className:"flex justify-center",children:e.jsx(S,{type:"button",size:"lg",className:"control-btn--primary px-8",onClick:n,children:"Next"})})}function fr(){const[n,d]=l.useState({isVisible:!1,xp:0,streak:0,type:"correct"});return{toast:n,showToast:(r,s="correct",p=0,i)=>{d({isVisible:!0,xp:r,streak:p,type:s,message:i})},hideToast:()=>{d(r=>({...r,isVisible:!1}))}}}const pr=[{id:"standard",label:"Standard"},{id:"heatmap",label:"Heatmap"},{id:"scale",label:"Scale"},{id:"intervals",label:"Intervals"}],hr=[0,2,4,5,7,9,11],Ae=["#fb7185","#f97316","#eab308","#22c55e","#38bdf8","#6366f1","#a855f7"],lt={root:Ae[0],third:Ae[2],fifth:Ae[4]},Ft={major:hr,minor:[0,2,3,5,7,8,10],majorPentatonic:[0,2,4,7,9],minorPentatonic:[0,3,5,7,10]},gr={major:"Major",minor:"Minor",majorPentatonic:"Major Pentatonic",minorPentatonic:"Minor Pentatonic"};function Pr(){const n=Ts(),d=Ms(),{isPlaying:a,score:f,streak:r,mode:s,targetNote:p,targetPosition:i,nextNote:h,nextPosition:y,noteOptions:u,noteToTabOptions:C,practiceConstraints:x,feedbackMessage:m,lastAnswer:c,bpm:N,noteDuration:k,isMetronomeOn:P,isMetronomeArmed:E,sessionStartTime:_,sessionCorrect:b,sessionIncorrect:A,setMode:R,setBpm:M,setNoteDuration:O,setPracticeConstraints:$,setForcedTargetNote:D,togglePracticeString:ae,startGame:ne,stopGame:V,submitNoteGuess:oe,submitPositionGuess:Pe,submitDetectedNote:Re,applyHintPenalty:Fe,toggleMetronome:o,advanceAfterAnswer:L}=me(),{heatMapEnabled:Y,toggleHeatMap:dt,getAccuracyForFretboard:Ie,streakDays:Gt,totalPracticeTime:mt,totalCorrect:De,totalIncorrect:ut,achievements:xt,sessionHistory:le,positionStats:qt}=Et(),Vt=re(t=>t.full.learning.autoAdvance),He=re(t=>t.full.gamification.showXPNotes),Ue=re(t=>t.full.gamification.showStreakWarnings),Ge=re(t=>t.full.gamification.showAchievements),ie=re(t=>t.full.instrument.leftHanded),ft=re(t=>t.quick.tuning),B=l.useMemo(()=>As(ft),[ft]),qe=re(t=>t.full.display),Xt=re(t=>t.updateFullSettings),[Kt,Wt]=l.useState(null),ce=Kt??qe.defaultLayer,Ve=l.useMemo(()=>Ps(B),[B]),G=d.state??null,Yt=!!(G?.mode||G?.source||G?.challenge),Zt=!!G?.openPreFlight&&!a,[g,Ee]=l.useState(G?.challenge??null),_e=l.useRef(Yt),[$e,de]=l.useState(G?.challenge?.type==="timed"?G.challenge.timeLimitSec??60:null),[Xe,ue]=l.useState([]),q=l.useRef(!1),[Jt,Ke]=l.useState(()=>Zt),[We,Ye]=l.useState(!1),[Le,Ze]=l.useState(!1),[Qt,pt]=l.useState(null),[es,ts]=l.useState(96),[je,Je]=l.useState(null),ve=l.useRef(0),we=l.useRef(0),ke=l.useRef(0),ze=l.useRef(null),{toast:Z,showToast:xe,hideToast:Se}=fr(),Qe=Jt;l.useEffect(()=>{!G||a||(_e.current=!0,G.mode&&G.mode!==s&&R(G.mode),G.constraints&&$(G.constraints),q.current=!1,n({pathname:d.pathname,search:d.search},{replace:!0,state:null}))},[G,a,s,R,$,n,d.pathname,d.search]),l.useEffect(()=>{a||We||Qe||_e.current||n("/train",{replace:!0})},[a,Qe,n,We]),l.useEffect(()=>{a&&r>ve.current&&(ve.current=r)},[r,a]),l.useEffect(()=>{if(!He){we.current=r;return}if(a&&r>we.current){const v=10+(r-1)*2;let F="correct",z;r===5?(F="streak",z="5 streak! Keep it up!"):r===10?(F="streak",z="Amazing! 10 streak!"):r===20&&(F="streak",z="Perfect Session! 20 streak!"),xe(v,F,r,z)}we.current=r},[r,a,xe,He]),l.useEffect(()=>{if(!a){ke.current=r;return}const t=ke.current,j=t>=5&&r===0&&t>r,v=!!(c&&!c.correct)||m==="Too slow!";Ue&&j&&v&&xe(0,"warning",t,`Streak broken at ${t}`),ke.current=r},[r,a,c,m,Ue,xe]),l.useEffect(()=>{const t=xt.filter(j=>j.unlockedAt);if(ze.current===null){ze.current=t.length;return}if(t.length>ze.current&&Ge){const j=[...t].sort((v,F)=>{const z=v.unlockedAt?new Date(v.unlockedAt).getTime():0;return(F.unlockedAt?new Date(F.unlockedAt).getTime():0)-z})[0];j&&xe(0,"achievement",0,j.name)}ze.current=t.length},[xt,Ge,xe]);const H=s==="playNotes"||s==="playTab"?"play":"guess",ss=s==="fretboardToNote"?"Fretboard → Note":s==="tabToNote"?"Tab → Note":s==="noteToTab"?"Note → Tab":s==="playNotes"?"Note Names (Mic)":"Tab Sequence (Mic)",rs=x.rootNote,as=gr[x.scaleType],ns=H==="guess"&&!P&&!Vt&&!!c,Be=H==="guess"&&s==="fretboardToNote",ht=Math.min(132,Math.max(es+8,108)),os=c?.selectedNote,et=b+A,gt=`${s}:${i?.stringIndex??"x"}-${i?.fret??"x"}:${p??"x"}`,bt=Qt===gt,tt=Z.isVisible?Z.type==="achievement"?Ge:Z.type==="warning"?Ue:He:!1;l.useEffect(()=>{Z.isVisible&&!tt&&Se()},[Z.isVisible,tt,Se]);const ls=t=>{Wt(t),qe.defaultLayer!==t&&Xt({display:{...qe,defaultLayer:t}})},[se,Nt]=l.useState(!1),{note:fe}=Js(se),st=l.useRef(null);l.useEffect(()=>{st.current=null},[s,p,i?.note,se]),l.useEffect(()=>{!se||!a||s!=="playNotes"&&s!=="playTab"||!fe||fe===st.current||(st.current=fe,Re(fe))},[fe,a,se,s,Re]);const rt=De+ut>0?Math.round(De/(De+ut)*100):0,is=l.useMemo(()=>{const t=new Map,j=T=>`${T.stringIndex}-${T.fret}`,v=T=>{t.set(j(T.position),T)},F=T=>{const I=j(T.position);t.has(I)||t.set(I,T)};c&&(v({position:c.position,status:c.correct?"correct":"incorrect",label:c.correct?i?.note:void 0}),!c.correct&&s==="noteToTab"&&i&&v({position:i,status:"correct",label:i.note})),a&&s==="fretboardToNote"&&i&&!c&&v({position:i,status:"active",label:"?",feedbackText:m==="Too slow!"?"Too slow!":void 0});const z=s==="fretboardToNote"?a?ce:Y?"heatmap":"standard":Y&&!a?"heatmap":"standard";if(z==="heatmap"&&Ie().forEach(({position:I,accuracy:X})=>{X!==null&&F({position:I,status:"idle",opacity:.18+X*.7})}),z==="scale"||z==="intervals"){const T=x.rootNote,I=x.scaleType,X=te.indexOf(T),vt=x.enabledStrings.map((K,pe)=>K?pe:-1).filter(K=>K>=0),wt=vt.length>0?vt:B.map((K,pe)=>pe),nt=Math.max(1,Math.min(12,x.fretRange.min)),kt=Math.max(nt,Math.min(12,x.fretRange.max));if(X>=0)if(z==="scale"){const K=new Map;(Ft[I]??Ft.major).forEach((he,Q)=>{const ee=te[(X+he)%te.length];K.set(ee,{degree:Q+1,color:Ae[Q%Ae.length]})});for(const he of wt)for(let Q=nt;Q<=kt;Q+=1){const ee=ot(B[he],Q),W=K.get(ee);W&&F({position:{stringIndex:he,fret:Q,note:ee},status:"idle",label:`${W.degree}`,color:W.color})}}else{const K=I==="minor"||I==="minorPentatonic"?3:4,pe=K===3?"b3":"3",he=te[(X+K)%te.length],Q=te[(X+7)%te.length];for(const ee of wt)for(let W=nt;W<=kt;W+=1){const ge=ot(B[ee],W);ge===T?F({position:{stringIndex:ee,fret:W,note:ge},status:"idle",label:"R",color:lt.root}):ge===he?F({position:{stringIndex:ee,fret:W,note:ge},status:"idle",label:pe,color:lt.third}):ge===Q&&F({position:{stringIndex:ee,fret:W,note:ge},status:"idle",label:"5",color:lt.fifth})}}}return Array.from(t.values())},[ce,Ie,Y,a,c,s,x.enabledStrings,x.fretRange.max,x.fretRange.min,x.rootNote,x.scaleType,m,i,B]),Ce=l.useMemo(()=>{if(g?.type!=="findAll"||!g.targetNote)return 0;const t=x.enabledStrings.map((T,I)=>T?I:-1).filter(T=>T>=0),j=t.length>0?t:B.map((T,I)=>I),v=Math.max(1,Math.min(12,x.fretRange.min)),F=Math.max(v,Math.min(12,x.fretRange.max));let z=0;for(const T of j)for(let I=v;I<=F;I+=1)ot(B[T],I)===g.targetNote&&(z+=1);return z},[g,x.enabledStrings,x.fretRange.max,x.fretRange.min,B]),at=g?.type==="findAll"?Ce:30,yt=t=>{a||(Ee(null),D(null),de(null),ue([]),R(t==="guess"?"fretboardToNote":"playNotes"))},cs=t=>{a||(Ee(null),D(null),de(null),ue([]),R(t))},ds=t=>{a||(Ee(null),D(null),de(null),ue([]),R(t))},ms=t=>{if(g?.type==="findAll"&&s==="noteToTab"&&i&&t.stringIndex===i.stringIndex&&t.fret===i.fret){const j=`${t.stringIndex}-${t.fret}`;ue(v=>v.includes(j)?v:[...v,j])}Pe(t)},us=()=>{Ke(!0)},xs=()=>{Ke(!1),ve.current=0,we.current=0,ke.current=0,ue([]),q.current=!1,g?.type==="findAll"&&g.targetNote?D(g.targetNote):D(null),de(g?.type==="timed"?g.timeLimitSec??60:null),ne()},fs=()=>{Ke(!1),_e.current&&!a&&n("/train",{replace:!0})},J=l.useCallback(()=>{const t=Date.now(),j=_?Math.floor((t-_)/1e3):0,v=le[le.length-1],F=v?Math.round(v.accuracy):null,z=b+A,T=z>0?Math.round(b/z*100):0,I=le.length>0?Math.max(...le.map(X=>Math.round(X.accuracy))):0;Je({score:f,correct:b,incorrect:A,maxStreak:ve.current,duration:j,previousAccuracy:F,isFirstSession:le.length===0,personalBest:le.length>0&&T>I}),Ze(!1),Se(),V(),D(null),Ye(!0)},[Se,f,b,le,A,_,D,V]);l.useEffect(()=>{if(!a||g?.type!=="timed"||Le)return;const t=window.setInterval(()=>{de(j=>{const v=g.timeLimitSec??60;return j===null?Math.max(0,v-1):Math.max(0,j-1)})},1e3);return()=>window.clearInterval(t)},[g,Le,a]),l.useEffect(()=>{!a||g?.type!=="timed"||$e===null||$e>0||q.current||(q.current=!0,J())},[g,$e,J,a]),l.useEffect(()=>{!a||g?.type!=="survival"||A<=0||q.current||(q.current=!0,J())},[g,J,a,A]),l.useEffect(()=>{!a||g?.type!=="findAll"||Ce<=0||Xe.length<Ce||q.current||(q.current=!0,J())},[g,J,Xe.length,Ce,a]),l.useEffect(()=>{a&&(g?.type==="timed"||g?.type==="survival"||g?.type==="findAll"||et<at||q.current||(q.current=!0,J()))},[g?.type,J,a,at,et]);const ps=()=>{q.current=!0,J()},hs=()=>Ze(!0),gs=()=>Ze(!1),bs=()=>{bt||c||(Fe(),pt(gt))},Ns=()=>{Ye(!1),Je(null),_e.current&&n("/train",{replace:!0})},jt=()=>{Ye(!1),Je(null),pt(null),ve.current=0,we.current=0,ke.current=0,ue([]),q.current=!1,g?.type==="findAll"&&g.targetNote?D(g.targetNote):D(null),de(g?.type==="timed"?g.timeLimitSec??60:null),setTimeout(()=>ne(),100)},ys=()=>{const t=Object.entries(qt).filter(([,j])=>j.total>=3).sort((j,v)=>j[1].correct/j[1].total-v[1].correct/v[1].total)[0];if(t){const[j]=t,[v,F]=j.split("-").map(Number),z=Array.from({length:B.length},(T,I)=>I===v);R("fretboardToNote"),$({fretRange:{min:Math.max(1,F-1),max:Math.min(12,F+1)},enabledStrings:z}),Ee(null),de(null)}jt()},js=je?je.correct*10+Math.max(0,(je.maxStreak-1)*je.maxStreak):0;return a?e.jsxs(e.Fragment,{children:[e.jsx(nr,{isPlaying:a,score:f,streak:r,correct:b,incorrect:A,bpm:N,noteDuration:k,modeLabel:ss,sessionStartTime:_,onPause:hs,onResume:gs,onStop:ps,isPaused:Le,progressCurrent:et,progressTarget:at,onHeightChange:ts}),e.jsx(or,{xp:Z.xp,streak:Z.streak,type:Z.type,message:Z.message,isVisible:tt,onClose:Se}),e.jsx(lr,{message:m}),g&&e.jsxs("div",{className:"fixed left-1/2 z-40 -translate-x-1/2 rounded-full border border-primary/40 bg-card/90 px-4 py-2 text-xs font-medium shadow-lg backdrop-blur-md",style:{top:`${ht+8}px`},children:[e.jsx("span",{className:"text-primary",children:g.label}),g.type==="timed"&&e.jsxs("span",{className:"ml-2 font-mono text-foreground",children:[$e??g.timeLimitSec??60,"s"]}),g.type==="survival"&&e.jsx("span",{className:"ml-2 text-foreground",children:"No mistakes"}),g.type==="findAll"&&e.jsxs("span",{className:"ml-2 font-mono text-foreground",children:[Xe.length,"/",Ce||"?"]})]}),e.jsxs("div",{className:w("fixed inset-0 z-40 bg-background flex flex-col",Le&&"blur-sm"),children:[e.jsx("div",{className:"shrink-0",style:{height:`${ht}px`}}),e.jsxs("div",{className:w("flex-1 w-full relative flex items-center justify-center overflow-x-hidden",Be?"overflow-y-auto":"overflow-hidden"),children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-transparent via-primary/5 to-transparent pointer-events-none"}),e.jsxs("div",{className:w("w-full max-w-[1400px] px-4 md:px-8 flex",Be?"flex-col items-center justify-start gap-1.5 pt-1 md:pt-3":"items-center justify-center"),children:[Be&&e.jsxs("div",{className:"w-full shrink-0 flex flex-col items-center gap-1.5",children:[e.jsx("div",{className:"w-full overflow-x-auto pb-1",children:e.jsx("div",{className:"mx-auto inline-flex min-w-max items-center gap-1 rounded-full border border-border/50 bg-card/85 p-1 backdrop-blur-md shadow-md",children:pr.map(t=>e.jsx(S,{type:"button",size:"sm",variant:ce===t.id?"secondary":"ghost",className:w("h-7 rounded-full px-2.5 text-[11px] md:h-8 md:px-3 md:text-xs",ce===t.id&&"text-primary border border-primary/20"),onClick:()=>ls(t.id),children:t.label},t.id))})}),(ce==="scale"||ce==="intervals")&&e.jsxs("div",{className:"text-[11px] font-medium text-muted-foreground rounded-full bg-card/80 border border-border/40 px-3 py-1 backdrop-blur",children:["Root: ",e.jsx("span",{className:"text-foreground font-semibold",children:rs})," • Scale: ",e.jsx("span",{className:"text-foreground font-semibold",children:as})]})]}),Be&&e.jsx("div",{className:"w-full transition-all duration-500 ease-out animate-in zoom-in-95 fade-in",children:e.jsx(St,{frets:12,activeLayer:ce,activeNotes:is,tuning:B,leftHanded:ie,className:"max-w-full drop-shadow-2xl"})}),H==="guess"&&s==="tabToNote"&&e.jsx("div",{className:"w-full transition-all duration-500 ease-out animate-in slide-in-from-bottom-4 fade-in",children:e.jsx(Oe,{tuning:B,position:i,leftHanded:ie,className:"w-full shadow-xl rounded-xl border border-border/20 bg-card/40 backdrop-blur-sm"})}),H==="guess"&&s==="noteToTab"&&e.jsxs("div",{className:"w-full max-w-md mx-auto text-center animate-in zoom-in-90 fade-in duration-500",children:[e.jsx("div",{className:"text-xs text-muted-foreground font-semibold tracking-wider uppercase mb-8",children:"Target Note"}),e.jsx("div",{className:"text-[12rem] font-black text-primary leading-none transition-all drop-shadow-2xl",children:p??"?"}),e.jsx("div",{className:"mt-12 text-lg text-muted-foreground/80 font-light",children:"Pick the matching tab position below"})]}),H==="play"&&s==="playNotes"&&e.jsxs("div",{className:"w-full max-w-md mx-auto text-center animate-in zoom-in-90 fade-in duration-500",children:[e.jsx("div",{className:"text-xs text-muted-foreground font-semibold tracking-wider uppercase mb-8",children:"Play This Note"}),e.jsx("div",{className:"text-[12rem] font-black text-primary leading-none transition-all drop-shadow-2xl",children:p??"?"}),e.jsxs("div",{className:"mt-12 flex items-center justify-center gap-6 text-base text-muted-foreground",children:[e.jsxs("span",{className:"rounded-full border border-border/50 bg-background/40 px-6 py-2 backdrop-blur-md shadow-sm",children:["Next: ",e.jsx("span",{className:"font-mono text-foreground font-bold",children:h??"--"})]}),e.jsxs("span",{className:"rounded-full border border-border/50 bg-background/40 px-6 py-2 backdrop-blur-md shadow-sm",children:["Mic: ",e.jsx("span",{className:w("font-mono font-bold transition-colors",se?"text-emerald-500":""),children:se?fe??"--":"Off"})]})]})]}),H==="play"&&s==="playTab"&&e.jsx("div",{className:"w-full max-w-6xl mx-auto backdrop-blur-sm bg-background/30 p-8 rounded-3xl border border-border/20 shadow-2xl",children:e.jsxs("div",{className:"grid gap-12 lg:grid-cols-2 items-center",children:[e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute -left-4 top-1/2 -translate-y-1/2 w-1 h-32 rounded-full bg-primary",style:{boxShadow:"0 0 15px hsl(var(--primary) / 0.5)"}}),e.jsx("div",{className:"text-xs text-primary font-bold tracking-[0.2em] uppercase mb-4 pl-2 opacity-80",children:"Current"}),e.jsx(Oe,{tuning:B,position:i,leftHanded:ie,className:"w-full max-w-none shadow-lg scale-105 transition-transform"}),i&&e.jsxs("div",{className:"mt-4 text-base font-medium text-muted-foreground pl-2",children:[Ve[i.stringIndex]," string, fret ",e.jsx("span",{className:"font-mono text-foreground text-lg",children:i.fret})]})]}),e.jsxs("div",{className:"opacity-50 scale-95 origin-left blur-[1px] transition-all group-hover:blur-0 group-hover:opacity-70",children:[e.jsx("div",{className:"text-xs text-muted-foreground font-bold tracking-[0.2em] uppercase mb-4 pl-2",children:"Next"}),e.jsx(Oe,{tuning:B,position:y,leftHanded:ie,className:"w-full max-w-none grayscale"}),y&&e.jsxs("div",{className:"mt-4 text-base text-muted-foreground pl-2",children:[Ve[y.stringIndex]," string, fret ",e.jsx("span",{className:"font-mono text-foreground",children:y.fret})]})]})]})})]})]}),e.jsx("div",{className:"shrink-0 w-full bg-gradient-to-t from-background via-background/95 to-transparent pt-3 md:pt-8 pb-16 md:pb-8 px-4 z-20",children:e.jsxs("div",{className:"max-w-4xl mx-auto space-y-4 md:space-y-6",children:[e.jsx("div",{className:"h-7 flex items-center justify-center text-lg md:text-xl font-medium tracking-tight","aria-live":"polite",children:e.jsx("span",{className:w("transition-all duration-300",m?.includes("Correct")&&"text-emerald-500 font-bold scale-110",m?.includes("Incorrect")&&"text-rose-500 font-bold shake",m?.includes("Too slow")&&"text-rose-500 font-bold animate-pulse-subtle",!m?.includes("Correct")&&!m?.includes("Incorrect")&&!m?.includes("Too slow")&&"text-muted-foreground/60"),children:m??"Identify the note!"})}),H==="guess"&&(s==="fretboardToNote"||s==="tabToNote")&&e.jsx(ir,{noteOptions:u,targetNote:i?.note,selectedNote:os,isLocked:!!c,isCorrect:c?.correct,isPlaying:a,onSubmit:oe}),H==="guess"&&s==="noteToTab"&&e.jsx(dr,{options:C,targetPosition:i??void 0,lastAnswerPosition:c?.position,isLocked:!!c,isCorrect:c?.correct,isPlaying:a,stringLabels:Ve,tuning:B,leftHanded:ie,onSubmit:ms}),ns&&e.jsx(xr,{onNext:L}),H==="guess"&&!c&&e.jsx(ur,{onHint:bs,hintUsed:bt}),H==="play"&&e.jsx(mr,{micEnabled:se,onMicChange:Nt})]})})]})]}):e.jsxs("div",{className:"space-y-6 pb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Practice"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Select a mode and configure your session"})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 bg-muted/20 p-1 rounded-lg border border-border/40 w-fit",children:[e.jsx(S,{type:"button",size:"sm",variant:H==="guess"?"secondary":"ghost",className:"h-8 px-4 text-xs font-semibold",onClick:()=>yt("guess"),children:"Guess Note"}),e.jsx(S,{type:"button",size:"sm",variant:H==="play"?"secondary":"ghost",className:"h-8 px-4 text-xs font-semibold",onClick:()=>yt("play"),children:"Play Practice"})]}),H==="guess"?e.jsx(Ct,{value:s,onValueChange:cs,className:"w-full",children:e.jsxs(Tt,{className:"grid w-full grid-cols-3 bg-muted/40 h-10",children:[e.jsx(Te,{value:"fretboardToNote",children:"Fretboard → Note"}),e.jsx(Te,{value:"tabToNote",children:"Tab → Note"}),e.jsx(Te,{value:"noteToTab",children:"Note → Tab"})]})}):e.jsx(Ct,{value:s,onValueChange:ds,className:"w-full",children:e.jsxs(Tt,{className:"grid w-full grid-cols-2 bg-muted/40 h-10",children:[e.jsx(Te,{value:"playNotes",children:"Note Names"}),e.jsx(Te,{value:"playTab",children:"Tab Sequence"})]})}),e.jsx(be,{className:"min-h-[300px] flex flex-col justify-center overflow-hidden bg-card/60",children:e.jsxs("div",{className:"p-6 md:p-8 flex items-center justify-center w-full",children:[H==="guess"&&s==="fretboardToNote"&&e.jsx("div",{className:"w-full opacity-90 pointer-events-none scale-95 origin-center",children:e.jsx(St,{frets:12,activeNotes:[{position:{stringIndex:2,fret:5,note:"C"},status:"active",label:"?"}],tuning:B,leftHanded:ie,className:"max-w-full"})}),(s==="tabToNote"||s==="playTab")&&e.jsx("div",{className:"w-full max-w-xl mx-auto opacity-90",children:e.jsx(Oe,{tuning:B,position:{stringIndex:1,fret:3,note:"D"},leftHanded:ie,className:"w-full scale-110 origin-center"})}),(s==="noteToTab"||s==="playNotes")&&e.jsxs("div",{className:"text-center space-y-4 py-8",children:[e.jsx("div",{className:"text-xs text-muted-foreground font-semibold tracking-wider uppercase",children:"Target"}),e.jsx("div",{className:"text-9xl font-black text-primary/80 animate-pulse-slow",children:"A"}),s==="playNotes"&&e.jsx("div",{className:"flex gap-2 justify-center mt-4",children:e.jsx("span",{className:"text-sm font-mono bg-muted px-2 py-1 rounded",children:"Next: C#"})})]})]})}),e.jsx(be,{children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"text-sm font-medium",children:"Tempo"}),e.jsxs("span",{className:"text-xs text-muted-foreground font-mono bg-muted px-1.5 py-0.5 rounded",children:[N," BPM"]})]}),e.jsx(Ne,{checked:E,onCheckedChange:o})]}),e.jsx(Me,{value:[N],onValueChange:([t])=>M(t),min:30,max:200,step:5,className:"w-full"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"text-sm font-medium",children:"Note Duration"}),e.jsxs("span",{className:"text-xs text-muted-foreground font-mono bg-muted px-1.5 py-0.5 rounded",children:[k," beat",k>1?"s":""]})]})}),e.jsx(Me,{value:[k],onValueChange:([t])=>O(t),min:1,max:16,step:1,className:"w-full"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Us,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(U,{htmlFor:"heatmap-toggle",className:"text-sm cursor-pointer",children:"Heat Map Overlay"})]}),e.jsx(Ne,{id:"heatmap-toggle",checked:Y,onCheckedChange:dt})]}),H==="play"&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(U,{htmlFor:"mic-toggle",className:"text-sm cursor-pointer",children:"Microphone"})]}),e.jsx(Ne,{id:"mic-toggle",checked:se,onCheckedChange:Nt})]}),e.jsxs(S,{size:"lg",className:"w-full control-btn--primary font-bold text-base shadow-lg shadow-primary/20 hover:shadow-primary/40 transition-all",onClick:us,children:[e.jsx(ct,{className:"mr-2 h-5 w-5 fill-current"})," Start Practice"]})]})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(be,{children:[e.jsx(Rs,{className:"pb-3",children:e.jsx(Fs,{className:"text-lg",children:"Instructions"})}),e.jsx("div",{className:"px-6 pb-6",children:e.jsxs("p",{className:"text-sm text-muted-foreground leading-relaxed",children:[s==="fretboardToNote"&&"Identify the note shown on the highlighted fretboard position. Select the correct note name from the options.",s==="tabToNote"&&"Read the guitar tablature and identify the corresponding note name. Great for improving sight-reading.",s==="noteToTab"&&"Find the correct position on the fretboard for the given note. You'll see a string and fret to select.",s==="playNotes"&&"Use your microphone! The app listens as you play the displayed note on your real guitar.",s==="playTab"&&"Sight-read and play the tablature sequence on your instrument. The app verifies your pitch in real-time."]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(be,{className:"p-4 flex flex-col items-center justify-center bg-muted/20",children:[e.jsx(Lt,{className:"w-6 h-6 text-amber-700 dark:text-amber-300 mb-2"}),e.jsx("div",{className:"text-2xl font-bold",children:Gt}),e.jsx("div",{className:"text-xs text-muted-foreground uppercase tracking-wider",children:"Day Streak"})]}),e.jsxs(be,{className:"p-4 flex flex-col items-center justify-center bg-muted/20",children:[e.jsx($t,{className:"w-6 h-6 text-primary mb-2"}),e.jsxs("div",{className:w("text-2xl font-bold",rt>=75?"text-emerald-600 dark:text-emerald-400":rt>=50?"text-amber-600 dark:text-amber-400":"text-rose-600 dark:text-rose-400"),children:[rt,"%"]}),e.jsx("div",{className:"text-xs text-muted-foreground uppercase tracking-wider",children:"Accuracy"})]}),e.jsxs(be,{className:"col-span-2 p-3 flex items-center justify-between bg-muted/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Bs,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-xs font-medium uppercase tracking-wider text-muted-foreground",children:"Time Practiced"})]}),e.jsxs("div",{className:"font-bold font-mono",children:[Math.floor(mt/60),"h ",mt%60,"m"]})]})]})]})]}),e.jsx(sr,{isOpen:Qe,onClose:fs,onStart:xs,mode:s,bpm:N,onBpmChange:M,noteDuration:k,onNoteDurationChange:O,isMetronomeOn:E,onMetronomeToggle:o,fretRange:x.fretRange,tuning:B,onFretRangeChange:t=>$({fretRange:t}),enabledStrings:x.enabledStrings,onStringToggle:ae,noteFilter:x.noteFilter,onNoteFilterChange:t=>$({noteFilter:t}),rootNote:x.rootNote,onRootNoteChange:t=>$({rootNote:t}),scaleType:x.scaleType,onScaleTypeChange:t=>$({scaleType:t}),onApplyPreset:t=>$(t)}),e.jsx(rr,{isOpen:We,onClose:Ns,onRestart:jt,onFocusWeakSpots:ys,stats:je,xpEarned:js})]})}export{Pr as default};
